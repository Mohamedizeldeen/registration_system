<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendee Management | Event Registration System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.2/axios.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .loading-overlay { 
            background: rgba(255, 255, 255, 0.9); 
            backdrop-filter: blur(2px); 
        }
    </style>
</head>
<body class="bg-gray-50">
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 loading-overlay flex items-center justify-center z-50 hidden">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
            <p class="mt-4 text-gray-600">Loading...</p>
        </div>
    </div>

    <!-- Header Section -->
    <div class="bg-white shadow-sm">
        <div class="max-w-6xl mx-auto px-4 py-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Attendee Management</h1>
                    <p class="text-gray-600 mt-2">Manage event registrations and attendee information</p>
                </div>
                <div class="flex space-x-3">
                    <button onclick="exportAttendees()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md transition duration-200 flex items-center">
                        <i class="fas fa-download mr-2"></i>Export CSV
                    </button>
                    <a href="create.html" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition duration-200 flex items-center">
                        <i class="fas fa-plus mr-2"></i>Register Attendee
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Messages -->
    <div id="alertContainer" class="max-w-6xl mx-auto px-4 pt-4 hidden">
        <div id="alertMessage" class="px-4 py-3 rounded relative" role="alert">
            <span id="alertText"></span>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-6xl mx-auto px-4 py-8">
        <!-- Search and Filter Section -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label for="searchName" class="block text-sm font-medium text-gray-700 mb-2">Search by Name</label>
                        <input type="text" id="searchName" placeholder="Enter attendee name..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="searchEmail" class="block text-sm font-medium text-gray-700 mb-2">Search by Email</label>
                        <input type="email" id="searchEmail" placeholder="Enter email address..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="filterEvent" class="block text-sm font-medium text-gray-700 mb-2">Filter by Event</label>
                        <select id="filterEvent" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">All Events</option>
                        </select>
                    </div>
                    <div>
                        <label for="filterStatus" class="block text-sm font-medium text-gray-700 mb-2">Filter by Status</label>
                        <select id="filterStatus" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">All Status</option>
                            <option value="confirmed">Confirmed</option>
                            <option value="pending">Pending</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                </div>
                <div class="mt-4 flex space-x-2">
                    <button onclick="searchAttendees()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition duration-200">
                        <i class="fas fa-search mr-2"></i>Search
                    </button>
                    <button onclick="clearFilters()" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-md transition duration-200">
                        <i class="fas fa-times mr-2"></i>Clear
                    </button>
                </div>
            </div>
        </div>

        <!-- Attendees Table -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Attendee</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Event</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ticket Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Registration Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="attendeesTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Dynamic content will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- No Data Message -->
        <div id="noDataMessage" class="bg-white rounded-lg shadow-sm border border-gray-200 p-8 text-center hidden">
            <i class="fas fa-users text-gray-400 text-4xl mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No Attendees Found</h3>
            <p class="text-gray-600 mb-4">There are no attendees matching your search criteria.</p>
            <a href="create.html" class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition duration-200">
                <i class="fas fa-plus mr-2"></i>Register First Attendee
            </a>
        </div>
    </div>

    <!-- Attendee Details Modal -->
    <div id="attendeeModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Attendee Details</h3>
                    <button onclick="closeAttendeeModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div id="attendeeDetails" class="space-y-4">
                    <!-- Dynamic content will be loaded here -->
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button onclick="closeAttendeeModal()" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-md transition duration-200">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Include API Configuration -->
    <script src="../assets/js/api.js"></script>
    <script>
        let attendees = [];
        let events = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadAttendees();
            loadEvents();
        });

        // Load all attendees
        async function loadAttendees() {
            try {
                showLoading();
                const response = await AttendeeAPI.getAll();
                attendees = response.data;
                renderAttendees(attendees);
            } catch (error) {
                console.error('Error loading attendees:', error);
                showAlert('Error loading attendees. Please try again.', 'error');
            } finally {
                hideLoading();
            }
        }

        // Load events for filter dropdown
        async function loadEvents() {
            try {
                const response = await EventAPI.getAll();
                events = response.data;
                populateEventFilter();
            } catch (error) {
                console.error('Error loading events:', error);
            }
        }

        // Populate event filter dropdown
        function populateEventFilter() {
            const eventSelect = document.getElementById('filterEvent');
            eventSelect.innerHTML = '<option value="">All Events</option>';
            
            events.forEach(event => {
                const option = document.createElement('option');
                option.value = event.id;
                option.textContent = event.name;
                eventSelect.appendChild(option);
            });
        }

        // Render attendees table
        function renderAttendees(attendeesData) {
            const tbody = document.getElementById('attendeesTableBody');
            const noDataMessage = document.getElementById('noDataMessage');

            if (attendeesData.length === 0) {
                tbody.innerHTML = '';
                noDataMessage.classList.remove('hidden');
                return;
            }

            noDataMessage.classList.add('hidden');
            
            tbody.innerHTML = attendeesData.map(attendee => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-10 w-10">
                                <div class="h-10 w-10 rounded-full bg-blue-500 flex items-center justify-center text-white font-medium">
                                    ${(attendee.first_name?.[0] || 'A').toUpperCase()}
                                </div>
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">
                                    ${attendee.first_name || ''} ${attendee.last_name || ''}
                                </div>
                                <div class="text-sm text-gray-500">${attendee.email || ''}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${attendee.event?.name || 'N/A'}</div>
                        <div class="text-sm text-gray-500">${attendee.event?.date || ''}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${attendee.ticket?.type || 'N/A'}</div>
                        <div class="text-sm text-gray-500">${attendee.ticket?.price ? '$' + attendee.ticket.price : ''}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${attendee.created_at ? new Date(attendee.created_at).toLocaleDateString() : 'N/A'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusColor(attendee.status)}">
                            ${attendee.status || 'Pending'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                        <button onclick="viewAttendee(${attendee.id})" class="text-blue-600 hover:text-blue-900">
                            <i class="fas fa-eye"></i>
                        </button>
                        <a href="edit.html?id=${attendee.id}" class="text-indigo-600 hover:text-indigo-900">
                            <i class="fas fa-edit"></i>
                        </a>
                        <button onclick="deleteAttendee(${attendee.id})" class="text-red-600 hover:text-red-900">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Get status color classes
        function getStatusColor(status) {
            switch(status?.toLowerCase()) {
                case 'confirmed': return 'bg-green-100 text-green-800';
                case 'pending': return 'bg-yellow-100 text-yellow-800';
                case 'cancelled': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // Search attendees
        function searchAttendees() {
            const searchName = document.getElementById('searchName').value.toLowerCase();
            const searchEmail = document.getElementById('searchEmail').value.toLowerCase();
            const filterEvent = document.getElementById('filterEvent').value;
            const filterStatus = document.getElementById('filterStatus').value;

            const filteredAttendees = attendees.filter(attendee => {
                const nameMatch = !searchName || 
                    (attendee.first_name?.toLowerCase() || '').includes(searchName) ||
                    (attendee.last_name?.toLowerCase() || '').includes(searchName);
                const emailMatch = !searchEmail || (attendee.email?.toLowerCase() || '').includes(searchEmail);
                const eventMatch = !filterEvent || attendee.event_id == filterEvent;
                const statusMatch = !filterStatus || attendee.status?.toLowerCase() === filterStatus;

                return nameMatch && emailMatch && eventMatch && statusMatch;
            });

            renderAttendees(filteredAttendees);
        }

        // Clear filters
        function clearFilters() {
            document.getElementById('searchName').value = '';
            document.getElementById('searchEmail').value = '';
            document.getElementById('filterEvent').value = '';
            document.getElementById('filterStatus').value = '';
            renderAttendees(attendees);
        }

        // View attendee details
        async function viewAttendee(id) {
            try {
                showLoading();
                const response = await AttendeeAPI.getById(id);
                const attendee = response.data;
                
                document.getElementById('attendeeDetails').innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">First Name</label>
                            <p class="mt-1 text-sm text-gray-900">${attendee.first_name || 'N/A'}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Last Name</label>
                            <p class="mt-1 text-sm text-gray-900">${attendee.last_name || 'N/A'}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Email</label>
                            <p class="mt-1 text-sm text-gray-900">${attendee.email || 'N/A'}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Phone</label>
                            <p class="mt-1 text-sm text-gray-900">${attendee.phone || 'N/A'}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Event</label>
                            <p class="mt-1 text-sm text-gray-900">${attendee.event?.name || 'N/A'}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Ticket Type</label>
                            <p class="mt-1 text-sm text-gray-900">${attendee.ticket?.type || 'N/A'}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Status</label>
                            <span class="mt-1 px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusColor(attendee.status)}">
                                ${attendee.status || 'Pending'}
                            </span>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Registration Date</label>
                            <p class="mt-1 text-sm text-gray-900">${attendee.created_at ? new Date(attendee.created_at).toLocaleDateString() : 'N/A'}</p>
                        </div>
                    </div>
                `;
                
                document.getElementById('attendeeModal').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading attendee details:', error);
                showAlert('Error loading attendee details. Please try again.', 'error');
            } finally {
                hideLoading();
            }
        }

        // Close attendee modal
        function closeAttendeeModal() {
            document.getElementById('attendeeModal').classList.add('hidden');
        }

        // Delete attendee
        async function deleteAttendee(id) {
            if (!confirm('Are you sure you want to delete this attendee? This action cannot be undone.')) {
                return;
            }

            try {
                showLoading();
                await AttendeeAPI.delete(id);
                showAlert('Attendee deleted successfully!', 'success');
                loadAttendees(); // Reload the list
            } catch (error) {
                console.error('Error deleting attendee:', error);
                showAlert('Error deleting attendee. Please try again.', 'error');
            } finally {
                hideLoading();
            }
        }

        // Export attendees
        async function exportAttendees() {
            try {
                showLoading();
                // This would typically call an export API endpoint
                showAlert('Export feature will be implemented soon.', 'info');
            } catch (error) {
                console.error('Error exporting attendees:', error);
                showAlert('Error exporting attendees. Please try again.', 'error');
            } finally {
                hideLoading();
            }
        }

        // Utility functions
        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            const alertMessage = document.getElementById('alertMessage');
            const alertText = document.getElementById('alertText');

            // Set alert style based on type
            alertMessage.className = 'px-4 py-3 rounded relative';
            switch(type) {
                case 'success':
                    alertMessage.classList.add('bg-green-100', 'border', 'border-green-400', 'text-green-700');
                    break;
                case 'error':
                    alertMessage.classList.add('bg-red-100', 'border', 'border-red-400', 'text-red-700');
                    break;
                case 'warning':
                    alertMessage.classList.add('bg-yellow-100', 'border', 'border-yellow-400', 'text-yellow-700');
                    break;
                default:
                    alertMessage.classList.add('bg-blue-100', 'border', 'border-blue-400', 'text-blue-700');
            }

            alertText.textContent = message;
            alertContainer.classList.remove('hidden');

            // Auto-hide after 5 seconds
            setTimeout(() => {
                alertContainer.classList.add('hidden');
            }, 5000);
        }
    </script>
    
    <script src="../assets/js/navigation.js"></script>
    <script>
        // Initialize navigation
        initializeNavigation('attendees', '../');
    </script>
</body>
</html>