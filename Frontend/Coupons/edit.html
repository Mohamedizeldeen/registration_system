<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Coupon | Event Registration System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../assets/js/axios.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .form-field-focus:focus {
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
    </style>
</head>
<body class="bg-gray-50">
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-white bg-opacity-90 items-center justify-center z-50 hidden">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-600 mx-auto"></div>
            <p class="mt-4 text-gray-600">Loading coupon details...</p>
        </div>
    </div>

    <!-- Header Section -->
    <div class="bg-white shadow-sm">
        <div class="max-w-4xl mx-auto px-4 py-6">
            <div class="flex items-center">
                <a href="index.html" class="text-gray-600 hover:text-gray-800 mr-4" title="Back to coupons">
                    <i class="fas fa-arrow-left text-xl"></i>
                </a>
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Edit Coupon</h1>
                    <p class="text-gray-600 mt-2">Update the details for this discount coupon</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Messages -->
    <div id="alertContainer" class="max-w-4xl mx-auto px-4 pt-4 hidden">
        <div id="alertMessage" class="px-4 py-3 rounded relative" role="alert">
            <span id="alertText"></span>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-4xl mx-auto px-4 py-8">
        <div class="bg-white rounded-lg shadow-md p-8">
            <form id="editCouponForm">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Coupon Code -->
                    <div>
                        <label for="code" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-tag mr-2"></i>Coupon Code <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="code" name="code" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none form-field-focus transition duration-200"
                            placeholder="e.g., SAVE20, EARLY50">
                        <p class="text-xs text-gray-500 mt-1">Enter a unique coupon code (uppercase recommended)</p>
                    </div>

                    <!-- Discount Percentage -->
                    <div>
                        <label for="discount" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-percent mr-2"></i>Discount Percentage <span class="text-red-500">*</span>
                        </label>
                        <input type="number" id="discount" name="discount" required min="1" max="100"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none form-field-focus transition duration-200"
                            placeholder="e.g., 20">
                        <p class="text-xs text-gray-500 mt-1">Discount percentage (1-100%)</p>
                    </div>

                    <!-- Expiry Date -->
                    <div>
                        <label for="expiryDate" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-calendar mr-2"></i>Expiry Date <span class="text-red-500">*</span>
                        </label>
                        <input type="date" id="expiryDate" name="expiryDate" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none form-field-focus transition duration-200">
                        <p class="text-xs text-gray-500 mt-1">When this coupon expires</p>
                    </div>

                    <!-- Max Usage -->
                    <div>
                        <label for="maxUsage" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-users mr-2"></i>Maximum Usage <span class="text-red-500">*</span>
                        </label>
                        <input type="number" id="maxUsage" name="maxUsage" required min="1"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none form-field-focus transition duration-200"
                            placeholder="e.g., 100">
                        <p class="text-xs text-gray-500 mt-1">Maximum number of times this coupon can be used</p>
                    </div>

                    <!-- Usage Count (Read-only) -->
                    <div>
                        <label for="usageCount" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-chart-line mr-2"></i>Current Usage
                        </label>
                        <input type="number" id="usageCount" name="usageCount" readonly
                            class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 text-gray-600"
                            placeholder="0">
                        <p class="text-xs text-gray-500 mt-1">Calculated from attendees with tickets using this coupon (auto-calculated)</p>
                    </div>


                </div>

                <!-- Submit Buttons -->
                <div class="flex justify-between mt-8">
                    <button type="button" onclick="deleteCoupon()"
                        class="px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-md transition duration-200 flex items-center" id="deleteButton">
                        <i class="fas fa-trash mr-2"></i>
                        Delete Coupon
                    </button>
                    
                    <div class="flex space-x-4">
                        <a href="index.html" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition duration-200">
                            Cancel
                        </a>
                        <button type="submit" class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-md transition duration-200 flex items-center" id="submitButton">
                            <i class="fas fa-save mr-2"></i>
                            <span id="submitText">Update Coupon</span>
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Current Coupon Preview -->
        <div class="mt-8 bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">
                <i class="fas fa-eye mr-2"></i>Current Coupon
            </h3>
            <div id="couponPreview" class="max-w-sm">
                <div class="bg-white rounded-lg shadow-md overflow-hidden border border-gray-200">
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-4">
                            <div class="bg-gradient-to-r from-green-500 to-blue-600 text-white px-3 py-1 rounded-full text-sm font-semibold">
                                <span id="preview-code">COUPON</span>
                            </div>
                            <span class="text-2xl font-bold text-green-600"><span id="preview-discount">0</span>%</span>
                        </div>
                        
                        <div class="space-y-2 mb-4">
                            <div class="flex items-center text-gray-600">
                                <i class="fas fa-calendar mr-2 text-red-500"></i>
                                <span>Expires: <span id="preview-expiry">Loading...</span></span>
                            </div>
                            <div class="flex items-center text-gray-600">
                                <i class="fas fa-users mr-2 text-purple-500"></i>
                                <span>Used: <span id="preview-used">0</span>/<span id="preview-usage">1</span></span>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span id="preview-status" class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                Active
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let couponId = null;
        let originalCoupon = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            // Get coupon ID from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            couponId = urlParams.get('id');
            
            if (!couponId) {
                showAlert('Coupon ID is required', 'error');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
                return;
            }
            
            // Always ensure CouponAPI is available
            await ensureCouponAPI();
            
            loadCouponData();
            setupFormSubmission();
            setupPreview();
        });

        // Ensure CouponAPI is available
        async function ensureCouponAPI() {
            console.log('ðŸ”§ Ensuring CouponAPI is available...');
            
            // Wait for axios
            let attempts = 0;
            while (typeof axios === 'undefined' && attempts < 50) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            // Create CouponAPI
            window.CouponAPI = {
                async getById(id) {
                    console.log(`ðŸ“ž CouponAPI.getById(${id}) called`);
                    const response = await axios.get(`http://localhost:3001/coupons/${id}`);
                    return response.data;
                },
                async update(id, couponData) {
                    console.log(`ðŸ“ž CouponAPI.update(${id}) called`);
                    const response = await axios.put(`http://localhost:3001/coupons/${id}`, couponData);
                    return response.data;
                },
                async delete(id) {
                    console.log(`ðŸ“ž CouponAPI.delete(${id}) called`);
                    const response = await axios.delete(`http://localhost:3001/coupons/${id}`);
                    return response.data;
                }
            };
            console.log('âœ… CouponAPI setup complete');
        }

        // Load coupon data for editing
        async function loadCouponData() {
            try {
                showLoading();
                const response = await CouponAPI.getById(couponId);
                originalCoupon = response; // Backend returns object directly
                populateForm(originalCoupon);
                updatePreview();
            } catch (error) {
                console.error('Error loading coupon data:', error);
                showAlert('Error loading coupon data. Please try again.', 'error');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
            } finally {
                hideLoading();
            }
        }



        // Populate form with coupon data
        function populateForm(coupon) {
            document.getElementById('code').value = coupon.code || '';
            document.getElementById('discount').value = coupon.discount || '';
            document.getElementById('expiryDate').value = coupon.expiryDate ? coupon.expiryDate.split('T')[0] : '';
            document.getElementById('maxUsage').value = coupon.maxUsage || '';
            document.getElementById('usageCount').value = coupon.usageCount || 0;
        }

        // Setup form submission
        function setupFormSubmission() {
            const form = document.getElementById('editCouponForm');
            form.addEventListener('submit', handleFormSubmit);
        }

        // Setup live preview
        function setupPreview() {
            document.getElementById('code').addEventListener('input', updatePreview);
            document.getElementById('discount').addEventListener('input', updatePreview);
            document.getElementById('expiryDate').addEventListener('change', updatePreview);
            document.getElementById('maxUsage').addEventListener('input', updatePreview);
        }

        // Update preview card
        function updatePreview() {
            const code = document.getElementById('code').value || 'COUPON';
            const discount = document.getElementById('discount').value || '0';
            const expiryDate = document.getElementById('expiryDate').value;
            const maxUsage = document.getElementById('maxUsage').value || '1';
            const usageCount = document.getElementById('usageCount').value || '0';

            document.getElementById('preview-code').textContent = code.toUpperCase();
            document.getElementById('preview-discount').textContent = discount;
            document.getElementById('preview-expiry').textContent = expiryDate ? new Date(expiryDate).toLocaleDateString() : 'Select date';
            document.getElementById('preview-usage').textContent = maxUsage;
            document.getElementById('preview-used').textContent = usageCount;

            // Update status
            updatePreviewStatus(expiryDate, parseInt(usageCount), parseInt(maxUsage));
        }

        // Update preview status
        function updatePreviewStatus(expiryDate, usageCount, maxUsage) {
            const statusEl = document.getElementById('preview-status');
            const now = new Date();
            const expiry = expiryDate ? new Date(expiryDate) : null;
            
            if (expiry && expiry < now) {
                statusEl.className = 'px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800';
                statusEl.textContent = 'Expired';
            } else if (usageCount >= maxUsage) {
                statusEl.className = 'px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800';
                statusEl.textContent = 'Used Up';
            } else {
                statusEl.className = 'px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800';
                statusEl.textContent = 'Active';
            }
        }

        // Handle form submission
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            const submitButton = document.getElementById('submitButton');
            const submitText = document.getElementById('submitText');
            
            try {
                // Disable submit button
                submitButton.disabled = true;
                submitText.textContent = 'Updating...';
                
                // Collect form data
                const formData = new FormData(e.target);
                const couponData = {
                    code: formData.get('code').toUpperCase(),
                    discount: parseFloat(formData.get('discount')),
                    expiryDate: formData.get('expiryDate') ? new Date(formData.get('expiryDate')).toISOString() : null,
                    maxUsage: parseInt(formData.get('maxUsage'))
                };

                // Validate required fields
                if (!couponData.code || !couponData.discount || !couponData.expiryDate || !couponData.maxUsage) {
                    throw new Error('Please fill in all required fields');
                }

                // Submit to API using CouponAPI
                const response = await CouponAPI.update(couponId, couponData);
                
                showAlert('Coupon updated successfully!', 'success');
                
                // Redirect to index after a short delay
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1500);
                
            } catch (error) {
                console.error('Error updating coupon:', error);
                let errorMessage = 'Error updating coupon. Please try again.';
                
                if (error.response?.data?.message) {
                    errorMessage = error.response.data.message;
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                showAlert(errorMessage, 'error');
                
                // Re-enable submit button
                submitButton.disabled = false;
                submitText.textContent = 'Update Coupon';
            }
        }

        // Delete coupon
        async function deleteCoupon() {
            if (!confirm('Are you sure you want to delete this coupon? This action cannot be undone.')) {
                return;
            }

            const deleteButton = document.getElementById('deleteButton');
            
            try {
                deleteButton.disabled = true;
                deleteButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Deleting...';
                
                await CouponAPI.delete(couponId);
                
                showAlert('Coupon deleted successfully!', 'success');
                
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1500);
                
            } catch (error) {
                console.error('Error deleting coupon:', error);
                showAlert('Error deleting coupon. Please try again.', 'error');
                
                deleteButton.disabled = false;
                deleteButton.innerHTML = '<i class="fas fa-trash mr-2"></i>Delete Coupon';
            }
        }

        // Utility functions
        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            const alertMessage = document.getElementById('alertMessage');
            const alertText = document.getElementById('alertText');

            // Set alert style based on type
            alertMessage.className = 'px-4 py-3 rounded relative';
            switch(type) {
                case 'success':
                    alertMessage.classList.add('bg-green-100', 'border', 'border-green-400', 'text-green-700');
                    break;
                case 'error':
                    alertMessage.classList.add('bg-red-100', 'border', 'border-red-400', 'text-red-700');
                    break;
                case 'warning':
                    alertMessage.classList.add('bg-yellow-100', 'border', 'border-yellow-400', 'text-yellow-700');
                    break;
                default:
                    alertMessage.classList.add('bg-blue-100', 'border', 'border-blue-400', 'text-blue-700');
            }

            alertText.textContent = message;
            alertContainer.classList.remove('hidden');

            // Auto-hide after 5 seconds
            setTimeout(() => {
                alertContainer.classList.add('hidden');
            }, 5000);
        }
    </script>
    
    <script src="../assets/js/navigation.js"></script>
    <script>
        // Initialize navigation
        initializeNavigation('coupons', '../');
    </script>
</body>
</html>
