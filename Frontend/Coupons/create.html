<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Coupon | Event Registration System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.2/axios.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .form-field-focus:focus {
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
    </style>
</head>
<body class="bg-gray-50">
    
    <!-- Header Section -->
    <div class="bg-white shadow-sm">
        <div class="max-w-4xl mx-auto px-4 py-6">
            <div class="flex items-center">
                <a href="index.html" class="text-gray-600 hover:text-gray-800 mr-4" title="Back to coupons">
                    <i class="fas fa-arrow-left text-xl"></i>
                </a>
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Create New Coupon</h1>
                    <p class="text-gray-600 mt-2">Set up a new discount coupon for your events</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Messages -->
    <div id="alertContainer" class="max-w-4xl mx-auto px-4 pt-4 hidden">
        <div id="alertMessage" class="px-4 py-3 rounded relative" role="alert">
            <span id="alertText"></span>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-4xl mx-auto px-4 py-8">
        <div class="bg-white rounded-lg shadow-md p-8">
            <form id="createCouponForm">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Coupon Code -->
                    <div>
                        <label for="code" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-tag mr-2"></i>Coupon Code <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="code" name="code" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none form-field-focus transition duration-200"
                            placeholder="e.g., SAVE20, EARLY50">
                        <p class="text-xs text-gray-500 mt-1">Enter a unique coupon code (uppercase recommended)</p>
                    </div>

                    <!-- Discount Percentage -->
                    <div>
                        <label for="discount" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-percent mr-2"></i>Discount Percentage <span class="text-red-500">*</span>
                        </label>
                        <input type="number" id="discount" name="discount" required min="1" max="100"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none form-field-focus transition duration-200"
                            placeholder="e.g., 20">
                        <p class="text-xs text-gray-500 mt-1">Discount percentage (1-100%)</p>
                    </div>

                    <!-- Ticket -->
                    <div>
                        <label for="ticket_id" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-ticket-alt mr-2"></i>Applicable Ticket <span class="text-red-500">*</span>
                        </label>
                        <select id="ticket_id" name="ticket_id" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none form-field-focus transition duration-200">
                            <option value="">Select a ticket</option>
                            <!-- Dynamic options will be loaded here -->
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Choose which ticket this coupon applies to</p>
                    </div>

                    <!-- Expiry Date -->
                    <div>
                        <label for="expiry_date" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-calendar mr-2"></i>Expiry Date <span class="text-red-500">*</span>
                        </label>
                        <input type="date" id="expiry_date" name="expiry_date" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none form-field-focus transition duration-200">
                        <p class="text-xs text-gray-500 mt-1">When this coupon expires</p>
                    </div>

                    <!-- Max Usage -->
                    <div>
                        <label for="max_usage" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-users mr-2"></i>Maximum Usage <span class="text-red-500">*</span>
                        </label>
                        <input type="number" id="max_usage" name="max_usage" required min="1"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none form-field-focus transition duration-200"
                            placeholder="e.g., 100" value="1">
                        <p class="text-xs text-gray-500 mt-1">Maximum number of times this coupon can be used</p>
                    </div>

                    <!-- Description (Optional) -->
                    <div class="md:col-span-2">
                        <label for="description" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-info-circle mr-2"></i>Description
                        </label>
                        <textarea id="description" name="description" rows="3"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none form-field-focus transition duration-200 resize-vertical"
                            placeholder="Optional description of the coupon offer"></textarea>
                        <p class="text-xs text-gray-500 mt-1">Additional details about this coupon (optional)</p>
                    </div>
                </div>

                <!-- Submit Buttons -->
                <div class="flex justify-end space-x-4 mt-8">
                    <a href="index.html" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition duration-200">
                        Cancel
                    </a>
                    <button type="submit" class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-md transition duration-200 flex items-center" id="submitButton">
                        <i class="fas fa-save mr-2"></i>
                        <span id="submitText">Create Coupon</span>
                    </button>
                </div>
            </form>
        </div>

        <!-- Preview Card -->
        <div class="mt-8 bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">
                <i class="fas fa-eye mr-2"></i>Coupon Preview
            </h3>
            <div id="couponPreview" class="max-w-sm">
                <div class="bg-white rounded-lg shadow-md overflow-hidden border-2 border-dashed border-gray-300">
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-4">
                            <div class="bg-gradient-to-r from-green-500 to-blue-600 text-white px-3 py-1 rounded-full text-sm font-semibold">
                                <span id="preview-code">COUPON</span>
                            </div>
                            <span class="text-2xl font-bold text-green-600"><span id="preview-discount">0</span>%</span>
                        </div>
                        
                        <div class="space-y-2 mb-4">
                            <div class="flex items-center text-gray-600">
                                <i class="fas fa-ticket-alt mr-2 text-blue-500"></i>
                                <span id="preview-ticket">Select a ticket</span>
                            </div>
                            <div class="flex items-center text-gray-600">
                                <i class="fas fa-calendar mr-2 text-red-500"></i>
                                <span>Expires: <span id="preview-expiry">Select date</span></span>
                            </div>
                            <div class="flex items-center text-gray-600">
                                <i class="fas fa-users mr-2 text-purple-500"></i>
                                <span>Used: 0/<span id="preview-usage">1</span></span>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                Active
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Include API Configuration -->
    <script src="../assets/js/api.js"></script>
    <script>
        let tickets = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadTickets();
            setupFormSubmission();
            setupPreview();
            setMinDate();
        });

        // Set minimum date to today
        function setMinDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('expiry_date').min = today;
        }

        // Load tickets for dropdown
        async function loadTickets() {
            try {
                const response = await TicketAPI.getAll();
                tickets = response.data;
                populateTicketDropdown();
            } catch (error) {
                console.error('Error loading tickets:', error);
                showAlert('Error loading tickets. Please refresh the page.', 'error');
            }
        }

        // Populate ticket dropdown
        function populateTicketDropdown() {
            const ticketSelect = document.getElementById('ticket_id');
            const defaultOption = ticketSelect.querySelector('option[value=""]');
            
            // Clear existing options except the first one
            ticketSelect.innerHTML = '';
            ticketSelect.appendChild(defaultOption);
            
            tickets.forEach(ticket => {
                const option = document.createElement('option');
                option.value = ticket.id;
                option.textContent = `${ticket.name} - $${ticket.price}`;
                option.dataset.ticketName = ticket.name;
                ticketSelect.appendChild(option);
            });
        }

        // Setup form submission
        function setupFormSubmission() {
            const form = document.getElementById('createCouponForm');
            form.addEventListener('submit', handleFormSubmit);
        }

        // Setup live preview
        function setupPreview() {
            document.getElementById('code').addEventListener('input', updatePreview);
            document.getElementById('discount').addEventListener('input', updatePreview);
            document.getElementById('ticket_id').addEventListener('change', updatePreview);
            document.getElementById('expiry_date').addEventListener('change', updatePreview);
            document.getElementById('max_usage').addEventListener('input', updatePreview);
        }

        // Update preview card
        function updatePreview() {
            const code = document.getElementById('code').value || 'COUPON';
            const discount = document.getElementById('discount').value || '0';
            const ticketSelect = document.getElementById('ticket_id');
            const ticketName = ticketSelect.selectedOptions[0]?.dataset.ticketName || 'Select a ticket';
            const expiryDate = document.getElementById('expiry_date').value;
            const maxUsage = document.getElementById('max_usage').value || '1';

            document.getElementById('preview-code').textContent = code.toUpperCase();
            document.getElementById('preview-discount').textContent = discount;
            document.getElementById('preview-ticket').textContent = ticketName;
            document.getElementById('preview-expiry').textContent = expiryDate ? new Date(expiryDate).toLocaleDateString() : 'Select date';
            document.getElementById('preview-usage').textContent = maxUsage;
        }

        // Handle form submission
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            const submitButton = document.getElementById('submitButton');
            const submitText = document.getElementById('submitText');
            
            try {
                // Disable submit button
                submitButton.disabled = true;
                submitText.textContent = 'Creating...';
                
                // Collect form data
                const formData = new FormData(e.target);
                const couponData = {
                    code: formData.get('code').toUpperCase(),
                    discount: parseInt(formData.get('discount')),
                    ticket_id: parseInt(formData.get('ticket_id')),
                    expiry_date: formData.get('expiry_date'),
                    max_usage: parseInt(formData.get('max_usage')),
                    usage_count: 0,
                    description: formData.get('description') || null
                };

                // Validate required fields
                if (!couponData.code || !couponData.discount || !couponData.ticket_id || !couponData.expiry_date || !couponData.max_usage) {
                    throw new Error('Please fill in all required fields');
                }

                // Submit to API
                const response = await CouponAPI.create(couponData);
                
                showAlert('Coupon created successfully!', 'success');
                
                // Redirect to index after a short delay
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1500);
                
            } catch (error) {
                console.error('Error creating coupon:', error);
                let errorMessage = 'Error creating coupon. Please try again.';
                
                if (error.response?.data?.message) {
                    errorMessage = error.response.data.message;
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                showAlert(errorMessage, 'error');
                
                // Re-enable submit button
                submitButton.disabled = false;
                submitText.textContent = 'Create Coupon';
            }
        }

        // Utility function to show alerts
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            const alertMessage = document.getElementById('alertMessage');
            const alertText = document.getElementById('alertText');

            // Set alert style based on type
            alertMessage.className = 'px-4 py-3 rounded relative';
            switch(type) {
                case 'success':
                    alertMessage.classList.add('bg-green-100', 'border', 'border-green-400', 'text-green-700');
                    break;
                case 'error':
                    alertMessage.classList.add('bg-red-100', 'border', 'border-red-400', 'text-red-700');
                    break;
                case 'warning':
                    alertMessage.classList.add('bg-yellow-100', 'border', 'border-yellow-400', 'text-yellow-700');
                    break;
                default:
                    alertMessage.classList.add('bg-blue-100', 'border', 'border-blue-400', 'text-blue-700');
            }

            alertText.textContent = message;
            alertContainer.classList.remove('hidden');

            // Auto-hide after 5 seconds
            setTimeout(() => {
                alertContainer.classList.add('hidden');
            }, 5000);
        }
    </script>
    
    <script src="../assets/js/navigation.js"></script>
    <script>
        // Initialize navigation
        initializeNavigation('coupons', '../');
    </script>
</body>
</html>