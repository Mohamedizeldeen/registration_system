<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticket Print Management | Event Registration System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../assets/js/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Print-specific styles */
        @page {
            size: A6 portrait;
            margin: 0;
        }
        
        .ticket-a6 {
            width: 105mm;
            height: 148mm;
            padding: 6mm;
            box-sizing: border-box;
            border: 2px solid #333;
            background: #fff;
            color: #111;
            font-family: 'Arial', sans-serif;
            font-size: 9px;
            line-height: 1.2;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            box-shadow: 0 2px 12px 0 rgba(0,0,0,0.08);
            margin: 10px auto;
            position: relative;
        }
        
        .ticket-header {
            text-align: center;
            margin-bottom: 6mm;
            border-bottom: 2px solid #242424;
            padding-bottom: 3mm;
            width: 100%;
        }
        
        .event-title {
            font-size: 13px;
            font-weight: bold;
            margin-bottom: 2mm;
            text-transform: uppercase;
            line-height: 1.1;
        }
        
        .company-name {
            font-size: 10px;
            margin-bottom: 0;
        }
        
        .attendee-section {
            background: rgba(0,0,0,0.03);
            padding: 4mm;
            margin: 4mm 0;
            border: 1px solid #e5e7eb;
            text-align: center;
            width: 100%;
            border-radius: 4px;
        }
        
        .attendee-name {
            font-size: 11px;
            font-weight: bold;
            margin-bottom: 1mm;
            line-height: 1.1;
        }
        
        .attendee-email {
            font-size: 8px;
            word-break: break-all;
        }
        
        .ticket-info {
            margin: 4mm 0;
            width: 100%;
        }
        
        .info-row {
            margin-bottom: 1.5mm;
            display: flex;
            justify-content: space-between;
            width: 100%;
        }
        
        .info-label {
            font-weight: bold;
            font-size: 8px;
            opacity: 0.8;
        }
        
        .info-value {
            font-size: 8px;
            text-align: right;
            word-wrap: break-word;
            opacity: 0.95;
        }
        
        .qr-section {
            text-align: center;
            margin: 4mm 0 2mm 0;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .qr-code {
            width: 25mm;
            height: 25mm;
            background: white;
            color: black;
            padding: 2mm;
            border: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            border-radius: 4px;
        }
        
        .qr-placeholder {
            width: 100%;
            height: 100%;
            background: #f0f0f0;
            border: 1px dashed #666;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 7px;
            text-align: center;
        }
        
        .qr-text {
            font-size: 7px;
            margin-top: 2mm;
            text-align: center;
        }
        
        .ticket-footer {
            text-align: center;
            font-size: 7px;
            border-top: 1px solid #e5e7eb;
            padding-top: 2mm;
            margin-top: auto;
            width: 100%;
        }
        
        .zone-info {
            background: #fef9c3;
            border: 1px solid #fde047;
            padding: 2mm;
            margin: 3mm 0;
            text-align: center;
            border-radius: 4px;
            width: 100%;
        }
        
        .zone-title {
            font-size: 7px;
            font-weight: bold;
            color: #b45309;
            text-transform: uppercase;
            margin-bottom: 1mm;
        }
        
        .zone-name {
            font-size: 9px;
            font-weight: bold;
            color: #92400e;
        }
        
        @media print {
            body {
                margin: 0;
                padding: 0;
                background: white;
            }
            
            .no-print {
                display: none !important;
            }
            
            .ticket-a6 {
                box-shadow: none;
                border: 1px solid #333;
                page-break-inside: avoid;
                margin: 0;
            }
            
            .tickets-container {
                background: white;
            }
        }
        
        .loading-overlay { 
            background: rgba(255, 255, 255, 0.9); 
            -webkit-backdrop-filter: blur(2px);
            backdrop-filter: blur(2px);
        }

        .modal-hidden {
            display: none;
        }

        .modal-flex {
            display: flex;
        }

        .qr-image {
            width: 100%;
            height: 100%;
        }

        .print-date {
            margin-top: 1mm;
        }

        /* Ensure navigation elements are clickable */
        #mobile-menu-toggle,
        #profile-dropdown-toggle {
            pointer-events: auto !important;
            cursor: pointer !important;
            z-index: 9999 !important;
        }

        .relative {
            position: relative !important;
        }

        #profile-dropdown {
            z-index: 9999 !important;
        }

        /* Ensure proper spacing for fixed navigation */
        body {
            padding-top: 0;
        }

        /* Hide mobile menu on larger screens */
        @media (min-width: 1280px) {
            #mobile-menu {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    
    <!-- Navigation -->
    <nav id="navigation" class="bg-white shadow-md no-print border-b fixed top-0 left-0 right-0 z-50">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center h-16">
                <!-- Logo/Brand -->
                <div class="flex items-center flex-shrink-0 min-w-0">
                    <div class="text-lg font-bold text-gray-800">
                        <i class="fas fa-calendar-check mr-2 text-blue-600"></i>
                        <span class="hidden sm:inline">Event Registration</span>
                        <span class="sm:hidden">ERS</span>
                    </div>
                </div>
                
                <!-- Desktop Navigation - Large screens only -->
                <div class="hidden 2xl:flex items-center space-x-1 flex-1 justify-center mx-4">
                    <a href="../SuperAdmin-dashboard/index.html" class="text-gray-700 hover:text-blue-600 hover:bg-gray-100 px-2 py-1 rounded text-xs font-medium transition duration-200 flex items-center whitespace-nowrap">
                        <i class="fas fa-tachometer-alt mr-1"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="../index.html" class="text-gray-700 hover:text-blue-600 hover:bg-gray-100 px-2 py-1 rounded text-xs font-medium transition duration-200 flex items-center whitespace-nowrap">
                        <i class="fas fa-calendar-alt mr-1"></i>
                        <span>Events</span>
                    </a>
                    <a href="../Attendees/index.html" class="text-gray-700 hover:text-blue-600 hover:bg-gray-100 px-2 py-1 rounded text-xs font-medium transition duration-200 flex items-center whitespace-nowrap">
                        <i class="fas fa-users mr-1"></i>
                        <span>Attendees</span>
                    </a>
                    <a href="../Companies/index.html" class="text-gray-700 hover:text-blue-600 hover:bg-gray-100 px-2 py-1 rounded text-xs font-medium transition duration-200 flex items-center whitespace-nowrap">
                        <i class="fas fa-building mr-1"></i>
                        <span>Companies</span>
                    </a>
                    <a href="../Tickets/index.html" class="text-gray-700 hover:text-blue-600 hover:bg-gray-100 px-2 py-1 rounded text-xs font-medium transition duration-200 flex items-center whitespace-nowrap">
                        <i class="fas fa-ticket-alt mr-1"></i>
                        <span>Tickets</span>
                    </a>
                    <a href="../EventZones/index.html" class="text-gray-700 hover:text-blue-600 hover:bg-gray-100 px-2 py-1 rounded text-xs font-medium transition duration-200 flex items-center whitespace-nowrap">
                        <i class="fas fa-map-marker-alt mr-1"></i>
                        <span>Zones</span>
                    </a>
                    <a href="../Coupons/index.html" class="text-gray-700 hover:text-blue-600 hover:bg-gray-100 px-2 py-1 rounded text-xs font-medium transition duration-200 flex items-center whitespace-nowrap">
                        <i class="fas fa-tags mr-1"></i>
                        <span>Coupons</span>
                    </a>
                    <a href="index.html" class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-medium transition duration-200 flex items-center border border-blue-200 whitespace-nowrap">
                        <i class="fas fa-print mr-1"></i>
                        <span>Print</span>
                    </a>
                </div>

                <!-- Medium Screen Navigation - Icons only -->
                <div class="hidden xl:flex 2xl:hidden items-center space-x-2 flex-1 justify-center mx-4">
                    <a href="../SuperAdmin-dashboard/index.html" class="text-gray-700 hover:text-blue-600 hover:bg-gray-100 p-2 rounded text-xs transition duration-200" title="Dashboard">
                        <i class="fas fa-tachometer-alt"></i>
                    </a>
                    <a href="../index.html" class="text-gray-700 hover:text-blue-600 hover:bg-gray-100 p-2 rounded text-xs transition duration-200" title="Events">
                        <i class="fas fa-calendar-alt"></i>
                    </a>
                    <a href="../Attendees/index.html" class="text-gray-700 hover:text-blue-600 hover:bg-gray-100 p-2 rounded text-xs transition duration-200" title="Attendees">
                        <i class="fas fa-users"></i>
                    </a>
                    <a href="../Companies/index.html" class="text-gray-700 hover:text-blue-600 hover:bg-gray-100 p-2 rounded text-xs transition duration-200" title="Companies">
                        <i class="fas fa-building"></i>
                    </a>
                    <a href="../Tickets/index.html" class="text-gray-700 hover:text-blue-600 hover:bg-gray-100 p-2 rounded text-xs transition duration-200" title="Tickets">
                        <i class="fas fa-ticket-alt"></i>
                    </a>
                    <a href="../EventZones/index.html" class="text-gray-700 hover:text-blue-600 hover:bg-gray-100 p-2 rounded text-xs transition duration-200" title="Event Zones">
                        <i class="fas fa-map-marker-alt"></i>
                    </a>
                    <a href="../Coupons/index.html" class="text-gray-700 hover:text-blue-600 hover:bg-gray-100 p-2 rounded text-xs transition duration-200" title="Coupons">
                        <i class="fas fa-tags"></i>
                    </a>
                    <a href="index.html" class="bg-blue-100 text-blue-700 p-2 rounded text-xs transition duration-200 border border-blue-200" title="Print">
                        <i class="fas fa-print"></i>
                    </a>
                </div>

                <!-- Profile/Settings - Only on large screens -->
                <div class="hidden xl:flex items-center flex-shrink-0">
                    <div class="relative">
                        <button id="profile-dropdown-toggle" class="flex items-center text-gray-700 hover:text-blue-600 p-2 rounded-full hover:bg-gray-100 transition duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500" title="Profile Settings">
                            <i class="fas fa-user-circle text-xl"></i>
                            <i class="fas fa-chevron-down ml-1 text-xs"></i>
                        </button>
                        
                        <!-- Profile Dropdown Menu -->
                        <div id="profile-dropdown" class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-50 hidden">
                            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition duration-200">
                                <i class="fas fa-user mr-2 w-4"></i>My Profile
                            </a>
                            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition duration-200">
                                <i class="fas fa-cog mr-2 w-4"></i>Settings
                            </a>
                            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition duration-200">
                                <i class="fas fa-bell mr-2 w-4"></i>Notifications
                            </a>
                            <div class="border-t border-gray-100 my-1"></div>
                            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition duration-200">
                                <i class="fas fa-question-circle mr-2 w-4"></i>Help & Support
                            </a>
                            <a href="#" class="block px-4 py-2 text-sm text-red-600 hover:bg-red-50 transition duration-200">
                                <i class="fas fa-sign-out-alt mr-2 w-4"></i>Sign Out
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Mobile Navigation Toggle -->
                <div class="xl:hidden flex-shrink-0">
                    <button id="mobile-menu-toggle" class="text-gray-700 hover:text-blue-600 focus:outline-none focus:text-blue-600 p-2" title="Toggle navigation menu" aria-label="Toggle navigation menu">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                </div>
            </div>

            <!-- Mobile Navigation Menu -->
            <div id="mobile-menu" class="xl:hidden hidden">
                <div class="px-2 pt-2 pb-3 space-y-1 bg-gray-50 rounded-lg mt-2 mb-2">
                    <a href="../SuperAdmin-dashboard/index.html" class="text-gray-700 hover:text-blue-600 hover:bg-white block px-3 py-2 rounded-md text-sm font-medium transition duration-200">
                        <i class="fas fa-tachometer-alt mr-2 w-5"></i>Dashboard
                    </a>
                    <a href="../index.html" class="text-gray-700 hover:text-blue-600 hover:bg-white block px-3 py-2 rounded-md text-sm font-medium transition duration-200">
                        <i class="fas fa-calendar-alt mr-2 w-5"></i>Events
                    </a>
                    <a href="../Attendees/index.html" class="text-gray-700 hover:text-blue-600 hover:bg-white block px-3 py-2 rounded-md text-sm font-medium transition duration-200">
                        <i class="fas fa-users mr-2 w-5"></i>Attendees
                    </a>
                    <a href="../Companies/index.html" class="text-gray-700 hover:text-blue-600 hover:bg-white block px-3 py-2 rounded-md text-sm font-medium transition duration-200">
                        <i class="fas fa-building mr-2 w-5"></i>Companies
                    </a>
                    <a href="../Tickets/index.html" class="text-gray-700 hover:text-blue-600 hover:bg-white block px-3 py-2 rounded-md text-sm font-medium transition duration-200">
                        <i class="fas fa-ticket-alt mr-2 w-5"></i>Tickets
                    </a>
                    <a href="../EventZones/index.html" class="text-gray-700 hover:text-blue-600 hover:bg-white block px-3 py-2 rounded-md text-sm font-medium transition duration-200">
                        <i class="fas fa-map-marker-alt mr-2 w-5"></i>Event Zones
                    </a>
                    <a href="../Coupons/index.html" class="text-gray-700 hover:text-blue-600 hover:bg-white block px-3 py-2 rounded-md text-sm font-medium transition duration-200">
                        <i class="fas fa-tags mr-2 w-5"></i>Coupons
                    </a>
                    <a href="index.html" class="bg-blue-100 text-blue-700 block px-3 py-2 rounded-md text-sm font-medium border border-blue-200">
                        <i class="fas fa-print mr-2 w-5"></i>Print
                    </a>
                    <div class="border-t pt-2 mt-2">
                        <div class="px-3 py-2">
                            <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Account</div>
                            <a href="#" class="text-gray-700 hover:text-blue-600 hover:bg-white block px-3 py-2 rounded-md text-sm font-medium transition duration-200">
                                <i class="fas fa-user mr-2 w-5"></i>My Profile
                            </a>
                            <a href="#" class="text-gray-700 hover:text-blue-600 hover:bg-white block px-3 py-2 rounded-md text-sm font-medium transition duration-200">
                                <i class="fas fa-cog mr-2 w-5"></i>Settings
                            </a>
                            <a href="#" class="text-gray-700 hover:text-blue-600 hover:bg-white block px-3 py-2 rounded-md text-sm font-medium transition duration-200">
                                <i class="fas fa-bell mr-2 w-5"></i>Notifications
                            </a>
                            <a href="#" class="text-gray-700 hover:text-blue-600 hover:bg-white block px-3 py-2 rounded-md text-sm font-medium transition duration-200">
                                <i class="fas fa-question-circle mr-2 w-5"></i>Help & Support
                            </a>
                            <a href="#" class="text-red-600 hover:text-red-700 hover:bg-red-50 block px-3 py-2 rounded-md text-sm font-medium transition duration-200">
                                <i class="fas fa-sign-out-alt mr-2 w-5"></i>Sign Out
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Header Section -->
    <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white shadow-lg no-print pt-16">
        <div class="max-w-7xl mx-auto px-4 py-6">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div class="flex-1 min-w-0">
                    <h1 class="text-2xl md:text-3xl font-bold flex items-center">
                        <i class="fas fa-ticket-alt mr-2 md:mr-3"></i>
                        <span class="truncate">Ticket Print Management</span>
                    </h1>
                    <p class="text-blue-100 mt-2 text-sm md:text-base">Print tickets and manage QR check-ins for your events</p>
                </div>
                <div class="flex space-x-2 md:space-x-4 flex-shrink-0">
                    <button id="tab-print" class="tab-button active bg-white/20 px-3 md:px-4 py-2 rounded-lg text-white font-medium transition duration-200 text-sm md:text-base" onclick="switchTab('print')">
                        <i class="fas fa-print mr-1 md:mr-2"></i><span class="hidden sm:inline">Print </span>Tickets
                    </button>
                    <button id="tab-scanner" class="tab-button bg-white/10 px-3 md:px-4 py-2 rounded-lg text-white font-medium hover:bg-white/20 transition duration-200 text-sm md:text-base" onclick="switchTab('scanner')">
                        <i class="fas fa-qrcode mr-1 md:mr-2"></i><span class="hidden sm:inline">QR </span>Scanner
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Content -->
    <div class="max-w-7xl mx-auto px-4 py-6">
        
        <!-- Print Tickets Tab -->
        <div id="print-content" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- Controls Panel -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                        <h2 class="text-xl font-semibold text-gray-900 mb-4">
                            <i class="fas fa-cogs mr-2 text-blue-600"></i>Ticket Generation
                        </h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <!-- Event Selection -->
                            <div>
                                <label for="eventFilter" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-calendar-alt mr-2"></i>Select Event
                                </label>
                                <select id="eventFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Select an event...</option>
                                </select>
                            </div>
                            
                            <!-- Attendee Search -->
                            <div class="md:col-span-2">
                                <label for="attendeeSearch" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-users mr-2"></i>Search Attendees
                                </label>
                                <div class="relative">
                                    <input type="text" id="attendeeSearch" 
                                           class="w-full px-3 py-2 pl-10 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                           placeholder="Search by name or email..." disabled>
                                    <i class="fas fa-search absolute left-3 top-3 text-gray-400 text-sm"></i>
                                </div>
                                
                                <!-- Search Results -->
                                <div id="attendeeResults" class="mt-2 hidden">
                                    <div class="border border-gray-200 rounded-md max-h-60 overflow-y-auto bg-white">
                                        <div class="p-3">
                                            <div class="flex items-center justify-between mb-2">
                                                <span class="text-sm font-medium text-gray-700">
                                                    <span id="resultCount">0</span> attendees found
                                                </span>
                                                <div class="flex space-x-2">
                                                    <button onclick="selectAllVisible()" class="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition duration-200">
                                                        Select All
                                                    </button>
                                                    <button onclick="clearAllSelected()" class="text-xs px-2 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 transition duration-200">
                                                        Clear All
                                                    </button>
                                                </div>
                                            </div>
                                            <div id="attendeeList" class="space-y-1">
                                                <!-- Search results will appear here -->
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Selected Count -->
                                    <div class="mt-2 flex justify-between items-center text-sm">
                                        <span class="text-gray-600">
                                            <span id="selectedCount">0</span> attendees selected
                                        </span>
                                        <span class="text-gray-500" id="searchHint">
                                            Start typing to search attendees...
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="flex space-x-3">
                            <button onclick="openAddAttendeeModal()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition duration-200">
                                <i class="fas fa-user-plus mr-2"></i>Add Attendee
                            </button>
                            <button onclick="loadTickets()" class="px-6 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg text-sm font-medium transition duration-200">
                                <i class="fas fa-refresh mr-2"></i>Generate Tickets
                            </button>
                            <button onclick="printTickets()" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium transition duration-200" id="printButton" disabled>
                                <i class="fas fa-print mr-2"></i>Print Selected
                            </button>
                            <button onclick="downloadPDF()" class="px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg text-sm font-medium transition duration-200" id="pdfButton" disabled>
                                <i class="fas fa-file-pdf mr-2"></i>Badge PDF
                            </button>
                        </div>
                    </div>
                    
                    <!-- Tickets Preview -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-semibold text-gray-900 mb-4">
                            <i class="fas fa-eye mr-2 text-green-600"></i>Ticket Preview
                        </h2>
                        <div class="tickets-container" id="ticketsContainer">
                            <!-- Preview Message -->
                            <div id="previewMessage" class="text-center py-12">
                                <div class="bg-gray-50 rounded-lg border-2 border-dashed border-gray-300 p-8">
                                    <i class="fas fa-ticket-alt text-gray-400 text-4xl mb-4"></i>
                                    <h3 class="text-lg font-medium text-gray-900 mb-2">No Tickets Generated</h3>
                                    <p class="text-gray-600">Select an event and attendees to generate ticket previews.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Statistics Panel -->
                <div class="space-y-6">
                    <!-- Stats Cards -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">
                            <i class="fas fa-chart-bar mr-2 text-purple-600"></i>Print Statistics
                        </h3>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Total Events</span>
                                <span id="totalEvents" class="font-semibold text-gray-900">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Total Attendees</span>
                                <span id="totalAttendees" class="font-semibold text-gray-900">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Tickets Generated</span>
                                <span id="ticketsGenerated" class="font-semibold text-green-600">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Ready to Print</span>
                                <span id="readyToPrint" class="font-semibold text-blue-600">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">
                            <i class="fas fa-bolt mr-2 text-yellow-600"></i>Quick Actions
                        </h3>
                        <div class="space-y-3">
                            <button onclick="selectAllAttendees()" class="w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-md transition duration-200">
                                <i class="fas fa-check-square mr-2 text-blue-600"></i>Select All Attendees
                            </button>
                            <button onclick="clearSelection()" class="w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-md transition duration-200">
                                <i class="fas fa-times-circle mr-2 text-red-600"></i>Clear Selection
                            </button>
                            <button onclick="previewSample()" class="w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-md transition duration-200">
                                <i class="fas fa-search mr-2 text-green-600"></i>Preview Sample
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- QR Scanner Tab -->
        <div id="scanner-content" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                
                <!-- QR Scanner -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">
                        <i class="fas fa-camera mr-2 text-blue-600"></i>QR Code Scanner
                    </h2>
                    
                    <div class="mb-4">
                        <div id="qr-reader" class="w-full"></div>
                    </div>
                    
                    <div class="flex space-x-3 mb-4">
                        <button id="start-scan" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200">
                            <i class="fas fa-play mr-2"></i>Start Scanner
                        </button>
                        <button id="stop-scan" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200 hidden">
                            <i class="fas fa-stop mr-2"></i>Stop Scanner
                        </button>
                    </div>
                    
                    <!-- Manual Input -->
                    <div class="border-t pt-4">
                        <h3 class="text-lg font-medium text-gray-900 mb-3">
                            <i class="fas fa-keyboard mr-2 text-green-600"></i>Manual Input
                        </h3>
                        <div class="flex space-x-2">
                            <input type="text" id="manual-qr" 
                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="Enter QR code or ticket ID">
                            <button id="manual-checkin" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200">
                                <i class="fas fa-check mr-2"></i>Check-in
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Check-in Results -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">
                        <i class="fas fa-list mr-2 text-purple-600"></i>Recent Check-ins
                    </h2>
                    
                    <div class="overflow-hidden">
                        <div class="max-h-96 overflow-y-auto">
                            <div id="recent-checkins" class="space-y-3">
                                <!-- Recent check-ins will be populated here -->
                                <div class="text-center py-8 text-gray-500">
                                    <i class="fas fa-inbox text-3xl mb-3"></i>
                                    <p>No recent check-ins</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- QR Statistics -->
            <div class="mt-6 grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-white rounded-lg shadow-md p-6 text-center">
                    <div class="text-2xl font-bold text-blue-600" id="totalScans">0</div>
                    <div class="text-sm text-gray-600">Total Scans</div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6 text-center">
                    <div class="text-2xl font-bold text-green-600" id="successfulCheckins">0</div>
                    <div class="text-sm text-gray-600">Successful Check-ins</div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6 text-center">
                    <div class="text-2xl font-bold text-yellow-600" id="alreadyCheckedIn">0</div>
                    <div class="text-sm text-gray-600">Already Checked In</div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6 text-center">
                    <div class="text-2xl font-bold text-red-600" id="failedScans">0</div>
                    <div class="text-sm text-gray-600">Failed Scans</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Messages -->
    <div id="alertContainer" class="fixed top-4 right-4 z-50 hidden no-print">
        <div id="alertMessage" class="px-6 py-4 rounded-lg shadow-lg" role="alert">
            <span id="alertText"></span>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="success-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 items-center justify-center z-50 no-print modal-hidden">
        <div class="bg-white rounded-lg shadow-lg p-6 max-w-md mx-4">
            <div class="text-center">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-check text-green-600 text-2xl"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">Check-in Successful!</h3>
                <p id="success-attendee" class="text-gray-600 mb-4"></p>
                <button onclick="closeModal()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200">
                    Continue Scanning
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-white bg-opacity-90 items-center justify-center z-50 no-print modal-hidden">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
            <p class="mt-4 text-gray-600">Loading...</p>
        </div>
    </div>

    <!-- Add Attendee Modal -->
    <div id="add-attendee-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 items-center justify-center z-50 no-print modal-hidden">
        <div class="bg-white rounded-lg shadow-lg p-6 max-w-lg mx-4 w-full">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-semibold text-gray-900">Add New Attendee</h3>
                <button onclick="closeAddAttendeeModal()" class="text-gray-400 hover:text-gray-600 transition duration-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="add-attendee-form" onsubmit="submitAttendee(event)">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <!-- First Name -->
                    <div>
                        <label for="attendee-first-name" class="block text-sm font-medium text-gray-700 mb-2">
                            First Name <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="attendee-first-name" name="firstName" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="Enter first name">
                    </div>
                    
                    <!-- Last Name -->
                    <div>
                        <label for="attendee-last-name" class="block text-sm font-medium text-gray-700 mb-2">
                            Last Name <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="attendee-last-name" name="lastName" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="Enter last name">
                    </div>
                </div>
                
                <!-- Email -->
                <div class="mb-4">
                    <label for="attendee-email" class="block text-sm font-medium text-gray-700 mb-2">
                        Email Address <span class="text-red-500">*</span>
                    </label>
                    <input type="email" id="attendee-email" name="email" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="Enter email address">
                </div>
                
                <!-- Phone -->
                <div class="mb-4">
                    <label for="attendee-phone" class="block text-sm font-medium text-gray-700 mb-2">
                        Phone Number
                    </label>
                    <input type="tel" id="attendee-phone" name="phone"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="Enter phone number">
                </div>
                
                <!-- Event Selection (auto-filled from current selection) -->
                <div class="mb-4">
                    <label for="attendee-event" class="block text-sm font-medium text-gray-700 mb-2">
                        Event <span class="text-red-500">*</span>
                    </label>
                    <select id="attendee-event" name="eventId" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Select an event...</option>
                    </select>
                </div>
                
                <!-- Company (optional) -->
                <div class="mb-6">
                    <label for="attendee-company" class="block text-sm font-medium text-gray-700 mb-2">
                        Company
                    </label>
                    <input type="text" id="attendee-company" name="company"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="Enter company name">
                </div>
                
                <!-- Form Actions -->
                <div class="flex space-x-3 justify-end">
                    <button type="button" onclick="closeAddAttendeeModal()" 
                            class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-lg text-sm font-medium transition duration-200">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition duration-200">
                        <i class="fas fa-user-plus mr-2"></i>Add Attendee
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Include Required Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
    <script>
        // Backend API Configuration
        const API_BASE_URL = 'http://localhost:3001';
        
        // Note: Make sure your backend has CORS enabled for frontend requests
        // Add this to your backend Express app:
        // app.use(cors({
        //     origin: ['http://localhost:3000', 'http://127.0.0.1:5500', 'http://localhost:5500'],
        //     credentials: true
        // }));

        // Test backend connection
        async function testBackendConnection() {
            console.log('🔍 Testing backend connection...');
            console.log('Frontend URL:', window.location.origin);
            console.log('Backend URL:', API_BASE_URL);
            
            try {
                const response = await fetch(`${API_BASE_URL}/events`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    mode: 'cors'
                });
                
                if (response.ok) {
                    console.log('✅ Backend connection successful!');
                    showAlert('Backend connection established successfully!', 'success');
                    return true;
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('❌ Backend connection failed:', error);
                
                if (error.message.includes('fetch') || error.name === 'TypeError') {
                    console.error('🚨 This is likely a CORS error!');
                    console.error('💡 Solution: Add this origin to your backend CORS configuration:');
                    console.error(`   Origin to add: ${window.location.origin}`);
                    console.error('💡 Backend file location: C:\\laragon\\www\\registration_system\\backend (Express Typescript Bun)\\index.ts');
                    console.error('💡 Look for Git conflict markers (<<<<<<< ======= >>>>>>>) and resolve them');
                    showAlert(`⚠️ Cannot connect to backend! This is likely a CORS issue. Please check the console for details and ensure backend is running on port 3001.`, 'error');
                } else {
                    showAlert(`Backend connection error: ${error.message}`, 'error');
                }
                return false;
            }
        }

        // Initialize page on DOM content loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, initializing...');
            testBackendConnection(); // Test connection first
            setupMobileMenu();
            setupProfileDropdown();
            loadEvents();
            setupEventListeners();
            initQRScanner();
            updateStats();
            updateButtons(); // Initialize button text
        });

        // Setup mobile menu functionality
        function setupMobileMenu() {
            console.log('Setting up mobile menu...');
            const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
            const mobileMenu = document.getElementById('mobile-menu');
            
            if (mobileMenuToggle && mobileMenu) {
                console.log('Mobile menu elements found, adding event listener');
                mobileMenuToggle.addEventListener('click', function(event) {
                    console.log('Mobile menu toggle clicked');
                    event.preventDefault();
                    event.stopPropagation();
                    
                    mobileMenu.classList.toggle('hidden');
                    
                    // Toggle hamburger icon
                    const icon = mobileMenuToggle.querySelector('i');
                    if (mobileMenu.classList.contains('hidden')) {
                        icon.className = 'fas fa-bars text-xl';
                        console.log('Mobile menu hidden');
                    } else {
                        icon.className = 'fas fa-times text-xl';
                        console.log('Mobile menu shown');
                    }
                });
                
                // Close mobile menu when clicking outside
                document.addEventListener('click', function(event) {
                    if (!mobileMenuToggle.contains(event.target) && !mobileMenu.contains(event.target)) {
                        mobileMenu.classList.add('hidden');
                        const icon = mobileMenuToggle.querySelector('i');
                        icon.className = 'fas fa-bars text-xl';
                    }
                });
                
                console.log('Mobile menu setup complete');
            } else {
                console.error('Mobile menu elements not found!');
                console.log('mobileMenuToggle:', mobileMenuToggle);
                console.log('mobileMenu:', mobileMenu);
            }
        }

        // Setup profile dropdown functionality
        function setupProfileDropdown() {
            console.log('Setting up profile dropdown...');
            const profileDropdownToggle = document.getElementById('profile-dropdown-toggle');
            const profileDropdown = document.getElementById('profile-dropdown');
            
            console.log('Profile dropdown toggle found:', !!profileDropdownToggle);
            console.log('Profile dropdown found:', !!profileDropdown);
            
            if (profileDropdownToggle && profileDropdown) {
                console.log('Setting up profile dropdown event listener...');
                profileDropdownToggle.addEventListener('click', function(event) {
                    console.log('Profile dropdown clicked!');
                    event.preventDefault();
                    event.stopPropagation();
                    
                    // Toggle dropdown visibility
                    const isHidden = profileDropdown.classList.contains('hidden');
                    console.log('Dropdown is currently hidden:', isHidden);
                    
                    if (isHidden) {
                        profileDropdown.classList.remove('hidden');
                        console.log('Showing dropdown');
                    } else {
                        profileDropdown.classList.add('hidden');
                        console.log('Hiding dropdown');
                    }
                });
                
                // Close profile dropdown when clicking outside
                document.addEventListener('click', function(event) {
                    if (!profileDropdownToggle.contains(event.target) && !profileDropdown.contains(event.target)) {
                        profileDropdown.classList.add('hidden');
                    }
                });
                
                console.log('Profile dropdown setup complete');
            } else {
                console.error('Profile dropdown elements not found!');
                console.log('profileDropdownToggle:', profileDropdownToggle);
                console.log('profileDropdown:', profileDropdown);
            }
        }

        // Global variables
        let events = [];
        let attendees = [];
        let allAttendees = [];
        let selectedAttendees = [];
        let filteredAttendees = [];
        let html5QrcodeScanner;
        let recentCheckins = [];
        let scanStats = {
            totalScans: 0,
            successfulCheckins: 0,
            alreadyCheckedIn: 0,
            failedScans: 0
        };

        // Sample data for demo
        const attendeeDatabase = {
            'ATT001': { id: 1, name: 'John Doe', email: 'john@example.com', event: 'Tech Conference 2025', status: 'active' },
            'ATT002': { id: 2, name: 'Jane Smith', email: 'jane@example.com', event: 'Marketing Summit 2025', status: 'active' },
            'ATT003': { id: 3, name: 'Bob Johnson', email: 'bob@example.com', event: 'Design Workshop 2025', status: 'checked_in' }
        };

        // Tab switching functionality
        function switchTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active', 'bg-white/20');
                btn.classList.add('bg-white/10');
            });
            document.getElementById(`tab-${tab}`).classList.add('active', 'bg-white/20');
            document.getElementById(`tab-${tab}`).classList.remove('bg-white/10');

            // Update content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(`${tab}-content`).classList.remove('hidden');

            // Stop scanner if switching away from scanner tab
            if (tab !== 'scanner' && html5QrcodeScanner) {
                stopScanning();
            }
        }

        // Load events for dropdown
        async function loadEvents() {
            try {
                console.log('Loading events from API:', API_BASE_URL);
                console.log('Frontend running from:', window.location.origin);
                
                // Try to load from backend API
                try {
                    const response = await fetch(`${API_BASE_URL}/events`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        mode: 'cors'
                    });
                    
                    console.log('Response status:', response.status);
                    console.log('Response headers:', [...response.headers.entries()]);
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('API response:', result);
                        // API returns events in allEvents property
                        const eventsArray = result.allEvents || result;
                        if (Array.isArray(eventsArray) && eventsArray.length > 0) {
                            events = eventsArray;
                            console.log('Loaded events from API:', events);
                            showAlert('Successfully connected to backend API!', 'success');
                        } else {
                            throw new Error('No events from API - received: ' + JSON.stringify(result));
                        }
                    } else {
                        throw new Error(`API request failed with status ${response.status}: ${response.statusText}`);
                    }
                } catch (apiError) {
                    console.error('Detailed API error:', apiError);
                    
                    // Check if it's a CORS error
                    if (apiError.message.includes('fetch') || apiError.name === 'TypeError') {
                        console.error('🚨 CORS ERROR DETECTED!');
                        console.error('Backend needs CORS configuration for origin:', window.location.origin);
                        showAlert(`CORS Error: Backend server at ${API_BASE_URL} is not accessible. Please check if backend is running and CORS is configured for ${window.location.origin}`, 'error');
                    } else {
                        showAlert(`API Error: ${apiError.message}`, 'error');
                    }
                    
                    // Fallback to sample data
                    console.log('Using sample data as fallback');
                    events = [
                        { id: 1, name: 'Tech Conference 2025', date: '2025-10-15', attendee_count: 150 },
                        { id: 2, name: 'Marketing Summit 2025', date: '2025-11-20', attendee_count: 85 },
                        { id: 3, name: 'Design Workshop 2025', date: '2025-12-05', attendee_count: 45 }
                    ];
                }
                
                populateEventDropdown();
                updateStatistics();
                console.log('Events loaded successfully');
            } catch (error) {
                console.error('Error loading events:', error);
                showAlert('Error loading events. Please refresh the page.', 'error');
            }
        }

        // Populate event dropdown
        function populateEventDropdown() {
            const eventSelect = document.getElementById('eventFilter');
            if (!eventSelect) {
                console.error('Event select element not found!');
                return;
            }
            
            console.log('Populating dropdown with events:', events);
            eventSelect.innerHTML = '<option value="">Select an event...</option>';
            
            events.forEach(event => {
                const option = document.createElement('option');
                option.value = event.id;
                option.textContent = `${event.name} - ${new Date(event.date).toLocaleDateString()}`;
                eventSelect.appendChild(option);
            });
            
            console.log('Dropdown populated, options count:', eventSelect.options.length);
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('eventFilter').addEventListener('change', onEventChange);
            
            // Attendee search listeners
            const attendeeSearch = document.getElementById('attendeeSearch');
            attendeeSearch.addEventListener('input', onAttendeeSearch);
            attendeeSearch.addEventListener('focus', showSearchResults);
            
            // QR Scanner listeners
            document.getElementById('start-scan').addEventListener('click', startScanning);
            document.getElementById('stop-scan').addEventListener('click', stopScanning);
            document.getElementById('manual-checkin').addEventListener('click', processManualCheckin);
            document.getElementById('manual-qr').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    processManualCheckin();
                }
            });
        }

        // Handle event selection change
        async function onEventChange() {
            const eventId = document.getElementById('eventFilter').value;
            const attendeeSearch = document.getElementById('attendeeSearch');
            const attendeeResults = document.getElementById('attendeeResults');
            
            if (!eventId) {
                attendeeSearch.disabled = true;
                attendeeSearch.placeholder = 'First select an event';
                attendeeResults.classList.add('hidden');
                selectedAttendees = [];
                filteredAttendees = [];
                allAttendees = [];
                updateButtons();
                return;
            }

            try {
                showLoading();
                
                // Load attendees from backend
                allAttendees = await loadAttendeesForEvent(eventId);
                filteredAttendees = [...allAttendees];
                
                attendeeSearch.disabled = false;
                attendeeSearch.placeholder = 'Search by name or email...';
                selectedAttendees = [];
                
                if (attendeeSearch.value) {
                    performSearch(attendeeSearch.value);
                } else {
                    displaySearchResults();
                }
                
                updateButtons();
                hideLoading();
            } catch (error) {
                console.error('Error loading attendees:', error);
                showAlert('Error loading attendees for this event.', 'error');
                hideLoading();
            }
        }

        // Attendee search functionality
        function onAttendeeSearch() {
            const searchTerm = document.getElementById('attendeeSearch').value.trim();
            performSearch(searchTerm);
        }

        function performSearch(searchTerm) {
            if (!searchTerm) {
                filteredAttendees = [...allAttendees];
            } else {
                filteredAttendees = allAttendees.filter(attendee => {
                    return attendee.full_name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                           attendee.email.toLowerCase().includes(searchTerm.toLowerCase());
                });
            }
            
            displaySearchResults();
            showSearchResults();
        }

        function showSearchResults() {
            const resultsContainer = document.getElementById('attendeeResults');
            resultsContainer.classList.remove('hidden');
        }

        function displaySearchResults() {
            const attendeeList = document.getElementById('attendeeList');
            const resultCount = document.getElementById('resultCount');
            const searchHint = document.getElementById('searchHint');
            
            resultCount.textContent = filteredAttendees.length;
            
            if (filteredAttendees.length === 0) {
                attendeeList.innerHTML = '<div class="text-center py-4 text-gray-500">No attendees found</div>';
                searchHint.textContent = 'Try different search terms';
            } else {
                let html = '';
                filteredAttendees.forEach(attendee => {
                    const isSelected = selectedAttendees.some(selected => selected.id === attendee.id);
                    html += `
                        <div class="flex items-center space-x-3 p-2 hover:bg-gray-50 rounded-md">
                            <input type="checkbox" id="attendee-${attendee.id}" 
                                   class="attendee-checkbox rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                   ${isSelected ? 'checked' : ''}
                                   onchange="toggleAttendeeSelection(${attendee.id})">
                            <label for="attendee-${attendee.id}" class="flex-1 cursor-pointer">
                                <div class="text-sm font-medium text-gray-900">${attendee.full_name}</div>
                                <div class="text-xs text-gray-500">${attendee.email}</div>
                            </label>
                        </div>
                    `;
                });
                attendeeList.innerHTML = html;
                searchHint.textContent = filteredAttendees.length === allAttendees.length ? 
                    'All attendees shown' : 'Filtered results';
            }
            
            updateSelectedCount();
        }

        function toggleAttendeeSelection(attendeeId) {
            const attendee = allAttendees.find(a => a.id === attendeeId);
            const index = selectedAttendees.findIndex(a => a.id === attendeeId);
            
            if (index > -1) {
                selectedAttendees.splice(index, 1);
            } else {
                selectedAttendees.push(attendee);
            }
            
            updateSelectedCount();
            updateButtons();
        }

        function selectAllVisible() {
            filteredAttendees.forEach(attendee => {
                if (!selectedAttendees.some(selected => selected.id === attendee.id)) {
                    selectedAttendees.push(attendee);
                }
            });
            displaySearchResults();
            updateButtons();
        }

        function clearAllSelected() {
            selectedAttendees = [];
            displaySearchResults();
            updateButtons();
        }

        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = selectedAttendees.length;
        }

        function updateButtons() {
            const hasSelection = selectedAttendees.length > 0;
            const printButton = document.getElementById('printButton');
            const pdfButton = document.getElementById('pdfButton');
            
            // Enable/disable buttons
            printButton.disabled = !hasSelection;
            pdfButton.disabled = !hasSelection;
            
            // Update button text based on selection context
            // Show "Print Selected" and "Badge PDF" when user has made a specific selection
            // (either through search filtering or manual selection, and not all attendees are selected)
            const searchTerm = document.getElementById('attendeeSearch').value.trim();
            const hasSearchFilter = searchTerm.length > 0;
            const hasPartialSelection = hasSelection && selectedAttendees.length < allAttendees.length;
            
            if (hasSelection && (hasSearchFilter || hasPartialSelection)) {
                // User has searched or made a specific selection
                printButton.innerHTML = '<i class="fas fa-print mr-2"></i>Print Selected';
                pdfButton.innerHTML = '<i class="fas fa-file-pdf mr-2"></i>Badge PDF';
            } else {
                // Default state or all attendees selected without search
                printButton.innerHTML = '<i class="fas fa-print mr-2"></i>Print All';
                pdfButton.innerHTML = '<i class="fas fa-file-pdf mr-2"></i>Save as PDF';
            }
        }

        // Generate sample attendees
        function generateSampleAttendees(event) {
            const sampleAttendees = [];
            const names = ['John Doe', 'Jane Smith', 'Bob Johnson', 'Alice Brown', 'Charlie Wilson'];
            
            for (let i = 1; i <= Math.min(event.attendee_count, 20); i++) {
                sampleAttendees.push({
                    id: i,
                    full_name: names[(i-1) % names.length] + ` ${i}`,
                    email: `attendee${i}@example.com`,
                    event_id: event.id,
                    event: event,
                    ticket: { name: 'General Admission', price: 99.99 },
                    checked_in_at: null
                });
            }
            
            return sampleAttendees;
        }

        // Load and display tickets
        function loadTickets() {
            const eventId = document.getElementById('eventFilter').value;
            
            if (!eventId) {
                showAlert('Please select an event first.', 'warning');
                return;
            }

            if (selectedAttendees.length === 0) {
                showAlert('Please select at least one attendee.', 'warning');
                return;
            }

            displayTickets(selectedAttendees);
            updateStatistics();
        }

        // Display tickets
        function displayTickets(attendeeList) {
            const container = document.getElementById('ticketsContainer');
            const previewMessage = document.getElementById('previewMessage');
            
            if (attendeeList.length === 0) {
                previewMessage.style.display = 'block';
                return;
            }

            previewMessage.style.display = 'none';
            let ticketsHTML = '<div class="grid gap-4">';

            attendeeList.forEach(attendee => {
                ticketsHTML += generateTicketHTML(attendee);
            });

            ticketsHTML += '</div>';
            container.innerHTML = ticketsHTML;

            // Generate QR codes
            attendeeList.forEach(attendee => {
                generateQRCode(attendee);
            });

            document.getElementById('readyToPrint').textContent = attendeeList.length;
        }

        // Generate individual ticket HTML
        function generateTicketHTML(attendee) {
            return `
                <div class="ticket-a6" id="ticket-${attendee.id}">
                    <div class="ticket-header">
                        <div class="event-title">${attendee.event.name}</div>
                        <div class="event-date">${new Date(attendee.event.date).toLocaleDateString('en-US', { 
                            weekday: 'long', 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        })}</div>
                    </div>
                    
                    <div class="attendee-info">
                        <div class="info-row">
                            <span class="info-label">Name:</span>
                            <span class="info-value">${attendee.full_name}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Email:</span>
                            <span class="info-value">${attendee.email}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Ticket:</span>
                            <span class="info-value">${attendee.ticket.name}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Attendee ID:</span>
                            <span class="info-value">ATT${String(attendee.id).padStart(3, '0')}</span>
                        </div>
                    </div>
                    
                    <div class="qr-section">
                        <div class="qr-code">
                            <div id="qr-${attendee.id}" class="qr-placeholder">
                                QR Code
                            </div>
                        </div>
                        <div class="qr-text">Scan for Check-in</div>
                    </div>
                    
                    <div class="ticket-footer">
                        <div class="footer-text">Keep this ticket for entry</div>
                        <div class="print-date">
                            Printed: ${new Date().toLocaleDateString('en-US', { month: 'short', day: '2-digit', year: 'numeric' })} ${new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}
                        </div>
                    </div>
                </div>
            `;
        }

        // Generate QR code for attendee
        async function generateQRCode(attendee) {
            try {
                const qrData = `ATT${String(attendee.id).padStart(3, '0')}`;
                const qrCodeDataURL = await QRCode.toDataURL(qrData, {
                    width: 100,
                    height: 100,
                    margin: 1,
                    color: {
                        dark: '#000000',
                        light: '#FFFFFF'
                    }
                });
                
                const qrContainer = document.getElementById(`qr-${attendee.id}`);
                if (qrContainer) {
                    qrContainer.innerHTML = `<img src="${qrCodeDataURL}" alt="QR Code" style="width: 100%; height: 100%;">`;
                }
            } catch (error) {
                console.error('Error generating QR code:', error);
            }
        }

        // Print tickets
        function printTickets() {
            window.print();
        }

        // Download as PDF
        function downloadPDF() {
            // Determine the appropriate message based on selection
            const searchTerm = document.getElementById('attendeeSearch').value.trim();
            const hasSearchFilter = searchTerm.length > 0;
            const hasPartialSelection = selectedAttendees.length > 0 && selectedAttendees.length < allAttendees.length;
            const isSelectedOnly = hasSearchFilter || hasPartialSelection;
            
            const message = isSelectedOnly 
                ? 'Badge PDF generation feature coming soon! Use browser print to save selected attendee badges as PDF.'
                : 'PDF generation feature coming soon! Use browser print to save as PDF.';
            
            showAlert(message, 'info');
            window.print();
        }

        // Quick action functions
        function selectAllAttendees() {
            if (allAttendees.length > 0) {
                selectedAttendees = [...allAttendees];
                displaySearchResults();
                updateButtons();
                showSearchResults();
            } else {
                showAlert('Please select an event first.', 'warning');
            }
        }

        function clearSelection() {
            selectedAttendees = [];
            displaySearchResults();
            updateButtons();
            document.getElementById('ticketsContainer').innerHTML = `
                <div id="previewMessage" class="text-center py-12">
                    <div class="bg-gray-50 rounded-lg border-2 border-dashed border-gray-300 p-8">
                        <i class="fas fa-ticket-alt text-gray-400 text-4xl mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">No Tickets Generated</h3>
                        <p class="text-gray-600">Select an event and attendees to generate ticket previews.</p>
                    </div>
                </div>
            `;
        }

        function previewSample() {
            if (allAttendees.length > 0) {
                displayTickets([allAttendees[0]]);
            } else {
                showAlert('Please select an event first.', 'warning');
            }
        }

        // Add Attendee Modal Functions
        function openAddAttendeeModal() {
            const modal = document.getElementById('add-attendee-modal');
            const eventSelect = document.getElementById('attendee-event');
            
            // Populate event dropdown in modal
            eventSelect.innerHTML = '<option value="">Select an event...</option>';
            events.forEach(event => {
                const option = document.createElement('option');
                option.value = event.id;
                option.textContent = `${event.name} - ${new Date(event.date).toLocaleDateString()}`;
                eventSelect.appendChild(option);
            });
            
            // Pre-select current event if one is selected
            const currentEventId = document.getElementById('eventFilter').value;
            if (currentEventId) {
                eventSelect.value = currentEventId;
            }
            
            // Show modal
            modal.classList.remove('modal-hidden');
            modal.classList.add('flex');
            
            // Focus on first input
            document.getElementById('attendee-first-name').focus();
        }

        function closeAddAttendeeModal() {
            const modal = document.getElementById('add-attendee-modal');
            modal.classList.add('modal-hidden');
            modal.classList.remove('flex');
            
            // Reset form
            document.getElementById('add-attendee-form').reset();
        }

        async function submitAttendee(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const attendeeData = {
                firstName: formData.get('firstName'),
                lastName: formData.get('lastName'),
                email: formData.get('email'),
                phone: formData.get('phone') || '',
                company: formData.get('company') || '',
                eventId: parseInt(formData.get('eventId'))
            };
            
            // Validate required fields
            if (!attendeeData.firstName || !attendeeData.lastName || !attendeeData.email || !attendeeData.eventId) {
                showAlert('Please fill in all required fields.', 'error');
                return;
            }

            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(attendeeData.email)) {
                showAlert('Please enter a valid email address.', 'error');
                return;
            }
            
            // Show loading
            showLoading();
            
            try {
                console.log('Submitting attendee data:', attendeeData);
                
                // Make API call to backend
                const response = await fetch(`${API_BASE_URL}/attendees`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    mode: 'cors',
                    body: JSON.stringify(attendeeData)
                });

                console.log('Attendee submission response status:', response.status);
                console.log('Response headers:', [...response.headers.entries()]);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Response error text:', errorText);
                    throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
                }

                const result = await response.json();
                console.log('Attendee submission result:', result);
                
                // Backend returns the created attendee in createdAttendee property
                if (result && (result.createdAttendee || result.id || result.data)) {
                    const attendeeResult = result.createdAttendee || result.data || result;
                    // Create attendee object for local update
                    const newAttendee = {
                        id: attendeeResult.id,
                        full_name: `${attendeeResult.firstName} ${attendeeResult.lastName}`,
                        email: attendeeResult.email,
                        phone: attendeeResult.phone || '',
                        company: attendeeResult.company || '',
                        event_id: attendeeResult.eventId || attendeeData.eventId,
                        event: events.find(e => e.id == (attendeeResult.eventId || attendeeData.eventId)),
                        ticket: { name: 'General Admission', price: 99.99 },
                        checked_in_at: attendeeResult.checkedInAt
                    };
                    
                    console.log('Created new attendee object:', newAttendee);
                    
                    // Add to attendees array if current event matches
                    const currentEventId = document.getElementById('eventFilter').value;
                    if (currentEventId == attendeeData.eventId) {
                        allAttendees.push(newAttendee);
                        filteredAttendees = [...allAttendees];
                        displaySearchResults();
                        showSearchResults();
                        
                        // Auto-select the new attendee
                        selectedAttendees.push(newAttendee);
                        updateButtons();
                        displaySearchResults();
                    }
                    
                    // Update statistics
                    updateStatistics();
                    
                    // Close modal and show success
                    closeAddAttendeeModal();
                    hideLoading();
                    showAlert(`Attendee "${newAttendee.full_name}" has been successfully added!`, 'success');
                    
                } else {
                    throw new Error('Failed to add attendee - invalid response');
                }
                
            } catch (error) {
                console.error('Detailed error adding attendee:', error);
                hideLoading();
                
                // More specific error handling
                if (error.message.includes('fetch') || error.name === 'TypeError') {
                    console.error('🚨 CORS/Network ERROR when adding attendee');
                    showAlert(`Cannot connect to backend at ${API_BASE_URL}. Please check if backend is running and CORS is configured for ${window.location.origin}`, 'error');
                } else if (error.message.includes('400')) {
                    showAlert('Invalid data provided. Please check your inputs.', 'error');
                } else if (error.message.includes('409')) {
                    showAlert('An attendee with this email already exists for this event.', 'error');
                } else if (error.message.includes('500')) {
                    showAlert('Server error. Please try again later.', 'error');
                } else {
                    showAlert(`Error adding attendee: ${error.message}`, 'error');
                }
            }
        }

        // Enhanced load attendees function to work with backend
        async function loadAttendeesForEvent(eventId) {
            try {
                console.log('Loading attendees for event:', eventId);
                const response = await fetch(`${API_BASE_URL}/attendees?event_id=${eventId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    mode: 'cors'
                });
                
                console.log('Attendees response status:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Attendees API response:', result);
                    // Based on your attendee controller, it returns { allAttendees: attendees }
                    if (result.allAttendees && Array.isArray(result.allAttendees)) {
                        const processedAttendees = result.allAttendees.map(attendee => ({
                            ...attendee,
                            full_name: attendee.full_name || `${attendee.firstName || ''} ${attendee.lastName || ''}`.trim(),
                            event: events.find(e => e.id == attendee.event_id),
                            ticket: { name: 'General Admission', price: 99.99 }
                        }));
                        console.log('Processed attendees:', processedAttendees);
                        return processedAttendees;
                    }
                } else {
                    throw new Error(`Failed to load attendees - HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('Detailed attendees loading error:', error);
                
                // Check if it's a CORS or network error
                if (error.message.includes('fetch') || error.name === 'TypeError') {
                    console.error('🚨 CORS/Network ERROR when loading attendees');
                    showAlert(`Cannot connect to backend at ${API_BASE_URL}. Please check if backend is running and CORS is configured.`, 'error');
                } else {
                    console.error('API Error:', error.message);
                    showAlert(`Error loading attendees: ${error.message}`, 'warning');
                }
                
                console.log('Using sample attendees data as fallback');
                // Fallback to sample data
                const selectedEvent = events.find(e => e.id == eventId);
                return generateSampleAttendees(selectedEvent);
            }
        }

        // Show/Hide loading functions
        function showLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.remove('modal-hidden');
            overlay.classList.add('flex');
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.add('modal-hidden');
            overlay.classList.remove('flex');
        }

        // Alert system functions
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            const alertMessage = document.getElementById('alertMessage');
            const alertText = document.getElementById('alertText');
            
            // Set message
            alertText.textContent = message;
            
            // Set style based on type
            alertMessage.className = 'px-6 py-4 rounded-lg shadow-lg';
            switch(type) {
                case 'success':
                    alertMessage.classList.add('bg-green-500', 'text-white');
                    break;
                case 'error':
                    alertMessage.classList.add('bg-red-500', 'text-white');
                    break;
                case 'warning':
                    alertMessage.classList.add('bg-yellow-500', 'text-white');
                    break;
                default:
                    alertMessage.classList.add('bg-blue-500', 'text-white');
            }
            
            // Show alert
            alertContainer.classList.remove('hidden');
            
            // Auto hide after 5 seconds
            setTimeout(() => {
                alertContainer.classList.add('hidden');
            }, 5000);
        }

        // Update statistics function
        function updateStatistics() {
            document.getElementById('totalEvents').textContent = events.length;
            document.getElementById('totalAttendees').textContent = allAttendees.length;
        }

        // QR Scanner Functions
        function initQRScanner() {
            // Scanner will be initialized when needed
        }

        function startScanning() {
            if (!html5QrcodeScanner) {
                html5QrcodeScanner = new Html5Qrcode("qr-reader");
            }

            Html5Qrcode.getCameras().then(devices => {
                if (devices && devices.length) {
                    const cameraId = devices[0].id;
                    html5QrcodeScanner.start(
                        cameraId,
                        {
                            fps: 10,
                            qrbox: { width: 250, height: 250 }
                        },
                        (decodedText) => {
                            processQRCode(decodedText);
                        },
                        (errorMessage) => {
                            // Ignore scanning errors
                        }
                    );
                    
                    document.getElementById('start-scan').classList.add('hidden');
                    document.getElementById('stop-scan').classList.remove('hidden');
                }
            }).catch(err => {
                console.error('Camera access denied:', err);
                showAlert('Camera access is required for QR scanning. Please allow camera access and refresh the page.', 'error');
            });
        }

        function stopScanning() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.stop().then(() => {
                    document.getElementById('start-scan').classList.remove('hidden');
                    document.getElementById('stop-scan').classList.add('hidden');
                });
            }
        }

        function processManualCheckin() {
            const qrCode = document.getElementById('manual-qr').value.trim();
            if (qrCode) {
                processQRCode(qrCode);
                document.getElementById('manual-qr').value = '';
            } else {
                showAlert('Please enter a QR code or ticket ID', 'warning');
            }
        }

        function processQRCode(qrCode) {
            console.log('Processing QR Code:', qrCode);
            scanStats.totalScans++;
            
            const attendee = attendeeDatabase[qrCode];
            
            if (attendee) {
                if (attendee.status === 'checked_in') {
                    // Already checked in
                    scanStats.alreadyCheckedIn++;
                    addRecentCheckin(attendee, 'already_checked_in');
                    showAlert(`${attendee.name} has already been checked in.`, 'warning');
                } else {
                    // Successful check-in
                    attendee.status = 'checked_in';
                    attendee.checked_in_at = new Date();
                    scanStats.successfulCheckins++;
                    addRecentCheckin(attendee, 'success');
                    showSuccessModal(attendee);
                    stopScanning();
                }
            } else {
                // Invalid QR code
                scanStats.failedScans++;
                addRecentCheckin({ name: qrCode, email: 'Unknown' }, 'failed');
                showAlert('Invalid QR code or attendee not found.', 'error');
            }
            
            updateStats();
        }

        function addRecentCheckin(attendee, status) {
            const checkin = {
                time: new Date(),
                attendee: attendee,
                status: status
            };
            
            recentCheckins.unshift(checkin);
            if (recentCheckins.length > 10) {
                recentCheckins.pop();
            }
            
            updateRecentCheckinsDisplay();
        }

        function updateRecentCheckinsDisplay() {
            const container = document.getElementById('recent-checkins');
            
            if (recentCheckins.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-inbox text-3xl mb-3"></i>
                        <p>No recent check-ins</p>
                    </div>
                `;
                return;
            }

            let html = '';
            recentCheckins.forEach(checkin => {
                const statusClass = checkin.status === 'success' ? 'bg-green-100 text-green-800' : 
                                  checkin.status === 'already_checked_in' ? 'bg-yellow-100 text-yellow-800' : 
                                  'bg-red-100 text-red-800';
                const statusIcon = checkin.status === 'success' ? 'fa-check' : 
                                 checkin.status === 'already_checked_in' ? 'fa-info-circle' : 
                                 'fa-times';
                const statusText = checkin.status === 'success' ? 'Checked In' : 
                                 checkin.status === 'already_checked_in' ? 'Already Checked In' : 
                                 'Failed';

                html += `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div class="flex-1">
                            <div class="font-medium text-gray-900">${checkin.attendee.name}</div>
                            <div class="text-sm text-gray-500">${checkin.time.toLocaleTimeString()}</div>
                        </div>
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">
                            <i class="fas ${statusIcon} mr-1"></i>
                            ${statusText}
                        </span>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function showSuccessModal(attendee) {
            document.getElementById('success-attendee').textContent = `${attendee.name} has been successfully checked in for ${attendee.event}`;
            const modal = document.getElementById('success-modal');
            modal.classList.remove('modal-hidden');
            modal.classList.add('modal-flex');
        }

        function closeModal() {
            const modal = document.getElementById('success-modal');
            modal.classList.add('modal-hidden');
            modal.classList.remove('modal-flex');
            setTimeout(() => {
                startScanning();
            }, 500);
        }

        function updateStats() {
            document.getElementById('totalScans').textContent = scanStats.totalScans;
            document.getElementById('successfulCheckins').textContent = scanStats.successfulCheckins;
            document.getElementById('alreadyCheckedIn').textContent = scanStats.alreadyCheckedIn;
            document.getElementById('failedScans').textContent = scanStats.failedScans;
        }

        function updateStatistics() {
            console.log('Updating statistics with events:', events);
            const totalEvents = events.length;
            const totalAttendees = events.reduce((sum, event) => sum + (event.attendee_count || 0), 0);
            
            document.getElementById('totalEvents').textContent = totalEvents;
            document.getElementById('totalAttendees').textContent = totalAttendees;
            
            console.log('Statistics updated - Events:', totalEvents, 'Attendees:', totalAttendees);
        }

        // Utility functions
        function showLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.remove('modal-hidden');
            overlay.classList.add('modal-flex');
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.add('modal-hidden');
            overlay.classList.remove('modal-flex');
        }

        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            const alertMessage = document.getElementById('alertMessage');
            const alertText = document.getElementById('alertText');
            
            const colorClasses = {
                'success': 'bg-green-100 text-green-800 border-green-200',
                'error': 'bg-red-100 text-red-800 border-red-200',
                'warning': 'bg-yellow-100 text-yellow-800 border-yellow-200',
                'info': 'bg-blue-100 text-blue-800 border-blue-200'
            };
            
            alertMessage.className = `px-6 py-4 rounded-lg shadow-lg border ${colorClasses[type]}`;
            alertText.textContent = message;
            alertContainer.classList.remove('hidden');
            
            setTimeout(() => {
                alertContainer.classList.add('hidden');
            }, 5000);
        }



        // Populate attendee dropdown
        function populateAttendeeDropdown() {
            const attendeeSelect = document.getElementById('attendeeFilter');
            if (!attendeeSelect) {
                console.error('Attendee select element not found!');
                return;
            }
            
            console.log('Populating attendees dropdown with:', allAttendees);
            attendeeSelect.innerHTML = '<option value="">Select attendees...</option>';
            attendeeSelect.innerHTML += '<option value="all">All Attendees</option>';
            
            allAttendees.forEach(attendee => {
                const option = document.createElement('option');
                option.value = attendee.id;
                option.textContent = `${attendee.full_name || (attendee.first_name + ' ' + attendee.last_name)} - ${attendee.email}`;
                attendeeSelect.appendChild(option);
            });
            
            console.log('Attendee dropdown populated, options count:', attendeeSelect.options.length);
        }

        // Load and display tickets
        async function loadTickets() {
            const eventId = document.getElementById('eventFilter').value;
            const attendeeSearch = document.getElementById('attendeeSearch').value;
            
            if (!eventId) {
                showAlert('Please select an event first.', 'warning');
                return;
            }

            try {
                showLoading();
                
                // Get selected attendees
                let selectedAttendees;
                if (attendeeValue === 'all') {
                    selectedAttendees = allAttendees;
                } else {
                    selectedAttendees = allAttendees.filter(attendee => attendee.id == attendeeValue);
                }

                if (selectedAttendees.length === 0) {
                    showAlert('No attendees found for the selected criteria.', 'warning');
                    return;
                }

                // Generate tickets
                await generateTickets(selectedAttendees);
                
            } catch (error) {
                console.error('Error loading tickets:', error);
                showAlert('Error loading tickets. Please try again.', 'error');
            } finally {
                hideLoading();
            }
        }

        // Generate ticket HTML
        async function generateTickets(attendeesList) {
            const container = document.getElementById('ticketsContainer');
            const previewMessage = document.getElementById('previewMessage');
            
            previewMessage.style.display = 'none';
            
            let ticketsHTML = '';
            
            for (const attendee of attendeesList) {
                const qrCodeDataURL = await generateQRCode(attendee);
                
                ticketsHTML += `
                    <div class="ticket-a6">
                        <!-- Header -->
                        <div class="ticket-header">
                            <div class="event-title">${attendee.event?.name || 'Event Ticket'}</div>
                            <div class="company-name">${attendee.event?.company?.name || attendee.company?.name || 'Event Company'}</div>
                        </div>
                        
                        <!-- Attendee Information -->
                        <div class="attendee-section">
                            <div class="attendee-name">
                                ${attendee.full_name || (attendee.first_name + ' ' + attendee.last_name)}
                            </div>
                            <div class="attendee-email">${attendee.email || 'No email'}</div>
                        </div>
                        
                        <!-- Zone Access Information -->
                        ${attendee.ticket?.eventZone ? `
                        <div class="zone-info">
                            <div class="zone-title">Zone Access</div>
                            <div class="zone-name">${attendee.ticket.eventZone.name}</div>
                        </div>
                        ` : ''}
                        
                        <!-- Event Information -->
                        <div class="ticket-info">
                            ${attendee.event?.date ? `
                            <div class="info-row">
                                <span class="info-label">Date:</span>
                                <span class="info-value">${new Date(attendee.event.date).toLocaleDateString('en-US', { month: 'short', day: '2-digit', year: 'numeric' })}</span>
                            </div>
                            ` : ''}
                            ${attendee.event?.time ? `
                            <div class="info-row">
                                <span class="info-label">Time:</span>
                                <span class="info-value">${attendee.event.time}</span>
                            </div>
                            ` : ''}
                            ${attendee.event?.location ? `
                            <div class="info-row">
                                <span class="info-label">Venue:</span>
                                <span class="info-value">${attendee.event.location.length > 20 ? attendee.event.location.substring(0, 20) + '...' : attendee.event.location}</span>
                            </div>
                            ` : ''}
                            ${attendee.ticket ? `
                            <div class="info-row">
                                <span class="info-label">Ticket:</span>
                                <span class="info-value">${attendee.ticket.name || 'Standard'}</span>
                            </div>
                            ` : ''}
                        </div>
                        
                        <!-- QR Code Section -->
                        <div class="qr-section">
                            <div class="qr-code">
                                ${qrCodeDataURL ? `<img src="${qrCodeDataURL}" class="qr-image" alt="QR Code">` : `
                                <div class="qr-placeholder">
                                    QR Code<br>
                                    #${attendee.id}
                                </div>
                                `}
                            </div>
                            <div class="qr-text">
                                Scan to Check-In • ID: ${attendee.id}
                            </div>
                        </div>
                        
                        <!-- Footer -->
                        <div class="ticket-footer">
                            <div class="footer-text">Present this ticket at the event entrance</div>
                            <div class="print-date">${new Date().toLocaleDateString('en-US', { month: 'short', day: '2-digit', year: 'numeric' })} ${new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}</div>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = ticketsHTML;
            showAlert(`Generated ${attendeesList.length} ticket(s) successfully!`, 'success');
        }

        // Generate QR Code
        async function generateQRCode(attendee) {
            try {
                const qrData = `ATTENDEE:${attendee.id}|EVENT:${attendee.event?.id || 'N/A'}|EMAIL:${attendee.email}`;
                
                const canvas = document.createElement('canvas');
                await QRCode.toCanvas(canvas, qrData, {
                    width: 70,
                    height: 70,
                    margin: 1,
                    color: {
                        dark: '#000000',
                        light: '#FFFFFF'
                    }
                });
                
                return canvas.toDataURL();
            } catch (error) {
                console.error('Error generating QR code:', error);
                return null;
            }
        }

        // Print tickets
        function printTickets() {
            const tickets = document.querySelectorAll('.ticket-a6');
            if (tickets.length === 0) {
                showAlert('No tickets to print. Please load tickets first.', 'warning');
                return;
            }
            
            window.print();
        }

        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            const alertMessage = document.getElementById('alertMessage');
            const alertText = document.getElementById('alertText');

            // Set alert style based on type
            alertMessage.className = 'px-4 py-3 rounded relative';
            switch(type) {
                case 'success':
                    alertMessage.classList.add('bg-green-100', 'border', 'border-green-400', 'text-green-700');
                    break;
                case 'error':
                    alertMessage.classList.add('bg-red-100', 'border', 'border-red-400', 'text-red-700');
                    break;
                case 'warning':
                    alertMessage.classList.add('bg-yellow-100', 'border', 'border-yellow-400', 'text-yellow-700');
                    break;
                default:
                    alertMessage.classList.add('bg-blue-100', 'border', 'border-blue-400', 'text-blue-700');
            }

            alertText.textContent = message;
            alertContainer.classList.remove('hidden');

            // Auto-hide after 5 seconds
            setTimeout(() => {
                alertContainer.classList.add('hidden');
            }, 5000);
        }
    </script>
</body>
</html>
