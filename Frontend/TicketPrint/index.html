<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticket Print Management | Event Registration System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../assets/js/axios.min.js"></script>
    <script src="../lib/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
    
    <!-- Navigation -->
    <nav id="navigation" class="bg-white shadow-md no-print border-b fixed top-0 left-0 right-0 z-50">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center h-16">
                <!-- Logo/Brand -->
                <div class="flex items-center flex-shrink-0 min-w-0">
                    <div class="text-lg font-bold text-gray-800">
                        <i class="fas fa-calendar-check mr-2 text-blue-600"></i>
                        <span class="hidden sm:inline">Event Registration</span>
                        <span class="sm:hidden">ERS</span>
                    </div>
                </div>
                
                <!-- Desktop Navigation -->
                <div class="hidden xl:flex items-center space-x-1 flex-1 justify-center mx-4">
                    <a href="../SuperAdmin-dashboard/index.html" class="text-gray-700 hover:text-blue-600 hover:bg-gray-100 px-2 py-1 rounded text-xs font-medium transition duration-200 flex items-center whitespace-nowrap">
                        <i class="fas fa-tachometer-alt mr-1"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="../index.html" class="text-gray-700 hover:text-blue-600 hover:bg-gray-100 px-2 py-1 rounded text-xs font-medium transition duration-200 flex items-center whitespace-nowrap">
                        <i class="fas fa-calendar-alt mr-1"></i>
                        <span>Events</span>
                    </a>
                    <a href="../Attendees/index.html" class="text-gray-700 hover:text-blue-600 hover:bg-gray-100 px-2 py-1 rounded text-xs font-medium transition duration-200 flex items-center whitespace-nowrap">
                        <i class="fas fa-users mr-1"></i>
                        <span>Attendees</span>
                    </a>
                    <a href="../Tickets/index.html" class="text-gray-700 hover:text-blue-600 hover:bg-gray-100 px-2 py-1 rounded text-xs font-medium transition duration-200 flex items-center whitespace-nowrap">
                        <i class="fas fa-ticket-alt mr-1"></i>
                        <span>Tickets</span>
                    </a>
                    <a href="index.html" class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-medium transition duration-200 flex items-center border border-blue-200 whitespace-nowrap">
                        <i class="fas fa-print mr-1"></i>
                        <span>Print</span>
                    </a>
                </div>

                <!-- Mobile Navigation Toggle -->
                <div class="xl:hidden flex-shrink-0">
                    <button id="mobile-menu-toggle" class="text-gray-700 hover:text-blue-600 focus:outline-none focus:text-blue-600 p-2" title="Toggle mobile menu">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                </div>
            </div>

            <!-- Mobile Navigation Menu -->
            <div id="mobile-menu" class="xl:hidden hidden">
                <div class="px-2 pt-2 pb-3 space-y-1 bg-gray-50 rounded-lg mt-2 mb-2">
                    <a href="../SuperAdmin-dashboard/index.html" class="text-gray-700 hover:text-blue-600 hover:bg-white block px-3 py-2 rounded-md text-sm font-medium transition duration-200">
                        <i class="fas fa-tachometer-alt mr-2 w-5"></i>Dashboard
                    </a>
                    <a href="../index.html" class="text-gray-700 hover:text-blue-600 hover:bg-white block px-3 py-2 rounded-md text-sm font-medium transition duration-200">
                        <i class="fas fa-calendar-alt mr-2 w-5"></i>Events
                    </a>
                    <a href="../Attendees/index.html" class="text-gray-700 hover:text-blue-600 hover:bg-white block px-3 py-2 rounded-md text-sm font-medium transition duration-200">
                        <i class="fas fa-users mr-2 w-5"></i>Attendees
                    </a>
                    <a href="../Tickets/index.html" class="text-gray-700 hover:text-blue-600 hover:bg-white block px-3 py-2 rounded-md text-sm font-medium transition duration-200">
                        <i class="fas fa-ticket-alt mr-2 w-5"></i>Tickets
                    </a>
                    <a href="index.html" class="bg-blue-100 text-blue-700 block px-3 py-2 rounded-md text-sm font-medium border border-blue-200">
                        <i class="fas fa-print mr-2 w-5"></i>Print
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Header Section -->
    <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white shadow-lg no-print pt-16">
        <div class="max-w-7xl mx-auto px-4 py-6">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div class="flex-1 min-w-0">
                    <h1 class="text-2xl md:text-3xl font-bold flex items-center">
                        <i class="fas fa-ticket-alt mr-2 md:mr-3"></i>
                        <span class="truncate">Ticket Print Management</span>
                    </h1>
                    <p class="text-blue-100 mt-2 text-sm md:text-base">Print tickets and manage event badges</p>
                </div>
                <div class="flex space-x-1 md:space-x-2 flex-shrink-0">
                    <button id="tab-print" class="tab-button active bg-white/20 px-2 md:px-3 py-2 rounded-lg text-white font-medium transition duration-200 text-xs md:text-sm" onclick="switchTab('print')">
                        <i class="fas fa-print mr-1"></i><span class="hidden sm:inline">Print </span>Badges
                    </button>
                    <button id="tab-scanner" class="tab-button bg-white/10 px-2 md:px-3 py-2 rounded-lg text-white font-medium hover:bg-white/20 transition duration-200 text-xs md:text-sm" onclick="switchTab('scanner')">
                        <i class="fas fa-qrcode mr-1"></i><span class="hidden sm:inline">QR </span>Scanner
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Content -->
    <div class="max-w-7xl mx-auto px-4 py-6">
        
        <!-- Print Tickets Tab -->
        <div id="print-content" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- Controls Panel -->
                <div class="lg:col-span-2 no-print">
                    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                        <h2 class="text-xl font-semibold text-gray-900 mb-4">
                            <i class="fas fa-cogs mr-2 text-blue-600"></i>Badge Generation
                        </h2>
                        
                        <div class="mb-6">
                            <!-- Event Selection -->
                            <div>
                                <label for="eventFilter" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-calendar-alt mr-2"></i>Select Event
                                </label>
                                <select id="eventFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="onEventChange()">
                                    <option value="">Select an event...</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Attendee Search & Selection -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-users mr-2"></i>Search & Select Attendees
                            </label>
                            
                            <!-- Search Box -->
                            <div class="mb-3">
                                <div class="relative">
                                    <input type="text" id="print-attendee-search" 
                                           class="w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                           placeholder="Search attendees by name or email"
                                           oninput="filterPrintAttendeeList()">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i class="fas fa-search text-gray-400"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Attendee List -->
                            <div id="attendeeContainer" class="border border-gray-300 rounded-lg p-4 bg-gray-50 max-h-64 overflow-y-auto">
                                <div class="text-center text-gray-500">
                                    <i class="fas fa-calendar-plus text-2xl mb-2"></i>
                                    <p>Select an event to view attendees</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Add New Attendee Section -->
                        <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="text-sm font-medium text-blue-900">
                                    <i class="fas fa-user-plus mr-2"></i>Quick Add Attendee
                                </h4>
                                <button onclick="toggleNewAttendeeForm()" id="toggleNewAttendeeBtn" class="text-sm text-blue-600 hover:text-blue-800 font-medium">
                                    <i class="fas fa-plus mr-1"></i>Add New
                                </button>
                            </div>
                            
                            <!-- New Attendee Form (Hidden by default) -->
                            <div id="newAttendeeForm" class="hidden space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Full Name *</label>
                                        <input type="text" id="newAttendeeFullName" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="John Doe" required>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Email *</label>
                                        <input type="email" id="newAttendeeEmail" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="john@example.com" required>
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Job Title *</label>
                                        <input type="text" id="newAttendeeJobTitle" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Software Engineer" required>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Company *</label>
                                        <input type="text" id="newAttendeeCompany" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Tech Corp" required>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Phone Number *</label>
                                    <input type="tel" id="newAttendeePhone" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="+1 (555) 123-4567" required>
                                </div>
                                <div class="flex gap-2 pt-2">
                                    <button onclick="createNewAttendee()" class="flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md text-sm font-medium transition duration-200">
                                        <i class="fas fa-plus mr-2"></i>Create & Select
                                    </button>
                                    <button onclick="clearNewAttendeeForm()" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-md text-sm font-medium transition duration-200">
                                        <i class="fas fa-times mr-2"></i>Cancel
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <button onclick="selectAllAttendees()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition duration-200">
                                <i class="fas fa-check-square mr-2"></i>Select All
                            </button>
                            <button onclick="clearSelection()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg text-sm font-medium transition duration-200">
                                <i class="fas fa-times-circle mr-2"></i>Clear All
                            </button>
                            <button onclick="printBadges()" class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg text-lg font-bold transition duration-200 shadow-lg" id="printButton" disabled>
                                <i class="fas fa-print mr-2"></i>Print Badges
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Statistics Panel -->
                <div class="space-y-6 no-print">
                    <!-- Stats Cards -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">
                            <i class="fas fa-chart-bar mr-2 text-purple-600"></i>Statistics
                        </h3>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Total Events</span>
                                <span id="totalEvents" class="font-semibold text-gray-900">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Total Attendees</span>
                                <span id="totalAttendees" class="font-semibold text-gray-900">0</span>
                            </div>
                            <div class="justify-between items-center hidden" id="currentEventRow">
                                <span class="text-gray-600">Current Event</span>
                                <span id="currentEventAttendees" class="font-semibold text-purple-600">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Selected</span>
                                <span id="selectedCount" class="font-semibold text-blue-600">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Generated</span>
                                <span id="generatedCount" class="font-semibold text-green-600">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- QR Scanner Tab -->
        <div id="scanner-content" class="tab-content hidden">
            <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
                
                <!-- QR Scanner -->
                <div class="xl:col-span-2">
                    <div class="bg-white rounded-lg shadow-md overflow-hidden">
                        <div class="bg-gradient-to-r from-blue-600 to-purple-600 p-4">
                            <h2 class="text-xl font-semibold text-white">
                                <i class="fas fa-qrcode mr-2"></i>QR Code Scanner
                            </h2>
                            <p class="text-blue-100 text-sm mt-1">Scan attendee QR codes for check-in</p>
                        </div>
                        
                        <div class="p-6">
                            <!-- Event Selection for Scanner -->
                            <div class="mb-4">
                                <label for="scannerEventFilter" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-calendar-alt mr-2 text-blue-600"></i>Select Event
                                </label>
                                <select id="scannerEventFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="onScannerEventChange()">
                                    <option value="">Select an event...</option>
                                </select>
                            </div>
                            
                            <!-- Scanner Area -->
                            <div class="mb-4">
                                <div id="qr-reader" class="w-full border-2 border-dashed border-gray-300 rounded-lg min-h-300 flex items-center justify-center bg-gray-50">
                                    <div class="text-center">
                                        <i class="fas fa-qrcode text-gray-400 text-4xl mb-3"></i>
                                        <p class="text-gray-500">QR Code Scanner</p>
                                        <p class="text-xs text-gray-400 mt-1">Select an event to start scanning</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Scanner Controls -->
                            <div class="flex space-x-3 mb-4">
                                <button id="start-scan" onclick="startScanning()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                    <i class="fas fa-play mr-2"></i>Start Scanner
                                </button>
                                <button id="stop-scan" onclick="stopScanning()" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-medium py-3 px-4 rounded-lg transition duration-200 hidden">
                                    <i class="fas fa-stop mr-2"></i>Stop Scanner
                                </button>
                            </div>
                            
                            <!-- Auto-Print Option -->
                            <div class="border-t pt-4">
                                <div class="flex items-center">
                                    <input type="checkbox" id="auto-print" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-2">
                                    <label for="auto-print" class="text-sm font-medium text-gray-700">
                                        <i class="fas fa-print mr-1 text-blue-600"></i>Auto-print badge after scan
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Attendee List -->
                    <div class="bg-white rounded-lg shadow-md overflow-hidden mt-6">
                        <div class="bg-gradient-to-r from-green-600 to-teal-600 p-4">
                            <h2 class="text-xl font-semibold text-white">
                                <i class="fas fa-users mr-2"></i>Event Attendees
                            </h2>
                            <p class="text-green-100 text-sm mt-1">Search and check-in attendees</p>
                        </div>
                        
                        <div class="p-6">
                            <!-- Search Box -->
                            <div class="mb-4">
                                <div class="relative">
                                    <input type="text" id="attendee-search" 
                                           class="w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                           placeholder="Search attendees by name, email, or company"
                                           oninput="filterAttendeeList()">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i class="fas fa-search text-gray-400"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Attendee List Container -->
                            <div id="scanner-attendee-list" class="border border-gray-200 rounded-lg max-h-96 overflow-y-auto">
                                <div class="text-center py-8 text-gray-500">
                                    <i class="fas fa-calendar-plus text-2xl mb-2"></i>
                                    <p>Select an event to view attendees</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Scanner Statistics -->
                <div class="space-y-6">
                    <!-- Real-time Statistics -->
                    <div class="bg-white rounded-lg shadow-md overflow-hidden">
                        <div class="bg-gradient-to-r from-green-600 to-blue-600 p-4">
                            <h2 class="text-lg font-semibold text-white">
                                <i class="fas fa-chart-line mr-2"></i>Scan Statistics
                            </h2>
                        </div>
                        
                        <div class="p-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div class="text-center p-3 bg-blue-50 rounded-lg">
                                    <div class="text-2xl font-bold text-blue-600" id="totalScans">0</div>
                                    <div class="text-xs text-blue-600 font-medium">Total Scans</div>
                                </div>
                                <div class="text-center p-3 bg-green-50 rounded-lg">
                                    <div class="text-2xl font-bold text-green-600" id="successfulScans">0</div>
                                    <div class="text-xs text-green-600 font-medium">Successful</div>
                                </div>
                                <div class="text-center p-3 bg-yellow-50 rounded-lg">
                                    <div class="text-2xl font-bold text-yellow-600" id="duplicateScans">0</div>
                                    <div class="text-xs text-yellow-600 font-medium">Duplicates</div>
                                </div>
                                <div class="text-center p-3 bg-red-50 rounded-lg">
                                    <div class="text-2xl font-bold text-red-600" id="failedScans">0</div>
                                    <div class="text-xs text-red-600 font-medium">Failed</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Scanned Attendee Info -->
                    <div id="scanned-attendee-info" class="bg-white rounded-lg shadow-md overflow-hidden hidden">
                        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-4">
                            <h2 class="text-lg font-semibold text-white">
                                <i class="fas fa-user-check mr-2"></i>Scanned Attendee
                            </h2>
                        </div>
                        
                        <div class="p-4">
                            <div id="attendee-data-display" class="space-y-3">
                                <!-- Attendee information will be displayed here -->
                            </div>
                            
                            <div class="mt-4 pt-4 border-t border-gray-200">
                                <button id="print-scanned-badge" onclick="printScannedAttendeeBadge()" 
                                        class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition duration-200">
                                    <i class="fas fa-print mr-2"></i>Print Badge
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="bg-white rounded-lg shadow-md overflow-hidden">
                        <div class="bg-gradient-to-r from-purple-600 to-pink-600 p-4">
                            <h2 class="text-lg font-semibold text-white">
                                <i class="fas fa-clock mr-2"></i>Recent Activity
                            </h2>
                        </div>
                        
                        <div class="p-4">
                            <div class="max-h-80 overflow-y-auto">
                                <div id="recent-activity" class="space-y-3">
                                    <div class="text-center py-8 text-gray-500">
                                        <i class="fas fa-inbox text-3xl mb-3 text-gray-300"></i>
                                        <p class="font-medium">No recent activity</p>
                                        <p class="text-sm">Start scanning to see activity</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Attendee Modal -->
    <div id="editAttendeeModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-40 no-print">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true"></div>
            
            <!-- Modal Content -->
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                            <i class="fas fa-edit text-blue-600"></i>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="editModalTitle">
                                Edit Attendee Information
                            </h3>
                            <div class="mt-4">
                                <form id="editAttendeeForm" class="space-y-4">
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label for="editFirstName" class="block text-sm font-medium text-gray-700">First Name *</label>
                                            <input type="text" id="editFirstName" name="firstName" required 
                                                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                        </div>
                                        <div>
                                            <label for="editLastName" class="block text-sm font-medium text-gray-700">Last Name *</label>
                                            <input type="text" id="editLastName" name="lastName" required 
                                                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                        </div>
                                    </div>
                                    <div>
                                        <label for="editEmail" class="block text-sm font-medium text-gray-700">Email *</label>
                                        <input type="email" id="editEmail" name="email" required 
                                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    </div>
                                    <div>
                                        <label for="editJobTitle" class="block text-sm font-medium text-gray-700">Job Title *</label>
                                        <input type="text" id="editJobTitle" name="jobTitle" required 
                                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    </div>
                                    <div>
                                        <label for="editCompany" class="block text-sm font-medium text-gray-700">Company *</label>
                                        <input type="text" id="editCompany" name="company" required 
                                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    </div>
                                    <div>
                                        <label for="editPhone" class="block text-sm font-medium text-gray-700">Phone Number *</label>
                                        <input type="tel" id="editPhone" name="phone" required 
                                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" onclick="saveAttendeeEdit()" 
                            class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                        <i class="fas fa-save mr-2"></i>Save Changes
                    </button>
                    <button type="button" onclick="closeEditModal()" 
                            class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Messages -->
    <div id="alertContainer" class="fixed top-4 right-4 z-50 hidden no-print">
        <div id="alertMessage" class="px-6 py-4 rounded-lg shadow-lg" role="alert">
            <span id="alertText"></span>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-white bg-opacity-90 z-50 no-print hidden">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
            <p class="mt-4 text-gray-600">Loading...</p>
        </div>
    </div>

    <script>
        // Backend API Configuration
        var API_BASE_URL = 'http://localhost:3001';
        
        // Global variables
        var events = [];
        var allAttendees = [];
        var selectedAttendees = [];
        var currentEvent = null;
        var scannerActive = false;
        var html5QrCode = null;
        var scanStats = {
            totalScans: 0,
            successfulScans: 0,
            duplicateScans: 0,
            failedScans: 0
        };

        // Initialize page on DOM content loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, initializing...');
            setupMobileMenu();
            loadEvents();
            
            // Check QR Code library availability
            checkQRCodeLibrary();
            
            // Initialize new attendee form state
            updateNewAttendeeFormState();
            
            // Update statistics after events are loaded
            setTimeout(function() {
                updateStats();
            }, 1000);
        });



        // Check which QR Code library is available
        function checkQRCodeLibrary() {
            console.log('Checking QR Code libraries...');
            
            if (typeof QRCode !== 'undefined') {
                console.log('QRCode library found');
                console.log('QRCode type:', typeof QRCode);
                console.log('QRCode.toCanvas available:', typeof QRCode.toCanvas === 'function');
                console.log('QRCode constructor available:', typeof QRCode === 'function');
                
                if (QRCode.CorrectLevel) {
                    console.log('QRCode.CorrectLevel available:', !!QRCode.CorrectLevel);
                }
            } else {
                console.warn('QRCode library not found');
            }
            
            // Check if window.QRCode exists (alternative namespace)
            if (typeof window.QRCode !== 'undefined') {
                console.log('window.QRCode library found');
            }
        }

        // Cleanup when page is unloaded
        window.addEventListener('beforeunload', function() {
            if (html5QrCode && scannerActive) {
                html5QrCode.stop().catch(err => {
                    console.warn('Error stopping scanner on page unload:', err);
                });
            }
        });

        // Display attendee list in scanner tab
        function displayScannerAttendeeList() {
            var container = document.getElementById('scanner-attendee-list');
            
            if (!allAttendees || allAttendees.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-500"><i class="fas fa-users text-2xl mb-2"></i><p>No attendees found for this event</p></div>';
                return;
            }
            
            renderAttendeeList(allAttendees);
        }

        // Filter attendee list based on search input
        function filterAttendeeList() {
            var searchTerm = document.getElementById('attendee-search').value.toLowerCase().trim();
            
            if (!allAttendees || allAttendees.length === 0) {
                return;
            }
            
            var filteredAttendees = allAttendees;
            
            if (searchTerm) {
                filteredAttendees = allAttendees.filter(function(attendee) {
                    var fullName = attendee.full_name || (attendee.firstName && attendee.lastName ? attendee.firstName + ' ' + attendee.lastName : '');
                    var email = attendee.email || '';
                    var company = attendee.company || '';
                    
                    return fullName.toLowerCase().includes(searchTerm) ||
                           email.toLowerCase().includes(searchTerm) ||
                           company.toLowerCase().includes(searchTerm);
                });
            }
            
            renderAttendeeList(filteredAttendees);
        }

        // Render the attendee list
        function renderAttendeeList(attendees) {
            var container = document.getElementById('scanner-attendee-list');
            
            if (attendees.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-500"><i class="fas fa-search text-2xl mb-2"></i><p>No attendees match your search</p></div>';
                return;
            }
            
            var html = '<div class="divide-y divide-gray-200">';
            
            for (var i = 0; i < attendees.length; i++) {
                var attendee = attendees[i];
                var isCheckedIn = attendee.checked_in_at;
                var statusClass = isCheckedIn ? 'text-green-600 bg-green-50' : 'text-yellow-600 bg-yellow-50';
                var statusIcon = isCheckedIn ? 'fa-check-circle' : 'fa-clock';
                var statusText = isCheckedIn ? 'Checked In' : 'Not Checked In';
                
                html += '<div class="flex items-center justify-between p-4 hover:bg-gray-50 transition duration-200">';
                html += '<div class="flex-1 min-w-0">';
                html += '<div class="font-medium text-gray-900 text-sm">' + attendee.full_name + '</div>';
                html += '<div class="text-xs text-gray-500 mt-1">' + attendee.email + '</div>';
                if (attendee.company) {
                    html += '<div class="text-xs text-gray-400 mt-1">' + attendee.company + '</div>';
                }
                html += '</div>';
                html += '<div class="flex items-center space-x-3">';
                html += '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ' + statusClass + '">';
                html += '<i class="fas ' + statusIcon + ' mr-1"></i>' + statusText;
                html += '</span>';
                if (!isCheckedIn) {
                    html += '<button onclick="checkInAttendeeFromList(' + attendee.id + ')" class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium py-1 px-3 rounded transition duration-200">';
                    html += '<i class="fas fa-check mr-1"></i>Check In';
                    html += '</button>';
                }
                html += '</div>';
                html += '</div>';
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Check in attendee from list
        function checkInAttendeeFromList(attendeeId) {
            var attendee = allAttendees.find(function(a) { return a.id === attendeeId; });
            
            if (attendee) {
                processCheckIn(attendee);
                
                // Generate and optionally print badge for this attendee
                setTimeout(function() {
                    displayBadges([attendee]);
                    
                    var autoPrint = document.getElementById('auto-print').checked;
                    if (autoPrint) {
                        setTimeout(function() {
                            printBadges();
                            showAlert('Badge generated and printed for ' + attendee.full_name + '!', 'success');
                        }, 1000);
                    } else {
                        showAlert('Badge generated for ' + attendee.full_name + '. Click Print to print the badge.', 'success');
                    }
                    
                    // Refresh the attendee list to show updated status
                    setTimeout(function() {
                        filterAttendeeList();
                    }, 500);
                }, 500);
            }
        }

        // Setup mobile menu functionality
        function setupMobileMenu() {
            var mobileMenuToggle = document.getElementById('mobile-menu-toggle');
            var mobileMenu = document.getElementById('mobile-menu');
            
            if (mobileMenuToggle && mobileMenu) {
                mobileMenuToggle.addEventListener('click', function(event) {
                    event.preventDefault();
                    event.stopPropagation();
                    
                    mobileMenu.classList.toggle('hidden');
                    
                    var icon = mobileMenuToggle.querySelector('i');
                    if (mobileMenu.classList.contains('hidden')) {
                        icon.className = 'fas fa-bars text-xl';
                    } else {
                        icon.className = 'fas fa-times text-xl';
                    }
                });
                
                document.addEventListener('click', function(event) {
                    if (!mobileMenuToggle.contains(event.target) && !mobileMenu.contains(event.target)) {
                        mobileMenu.classList.add('hidden');
                        var icon = mobileMenuToggle.querySelector('i');
                        icon.className = 'fas fa-bars text-xl';
                    }
                });
            }
        }

        // Tab switching functionality
        function switchTab(tab) {
            // Update tab buttons
            var tabButtons = document.querySelectorAll('.tab-button');
            for (var i = 0; i < tabButtons.length; i++) {
                tabButtons[i].classList.remove('active', 'bg-white/20');
                tabButtons[i].classList.add('bg-white/10');
            }
            document.getElementById('tab-' + tab).classList.add('active', 'bg-white/20');
            document.getElementById('tab-' + tab).classList.remove('bg-white/10');

            // Update content
            var tabContents = document.querySelectorAll('.tab-content');
            for (var i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.add('hidden');
            }
            document.getElementById(tab + '-content').classList.remove('hidden');

            // Stop scanner when switching away from scanner tab
            if (tab !== 'scanner' && scannerActive && html5QrCode) {
                stopScanning();
            }
        }

        // Load events from API
        function loadEvents() {
            console.log('Loading events from API...');
            
            // Try to load from backend API
            fetch(API_BASE_URL + '/events', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                },
                mode: 'cors'
            })
            .then(function(response) {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('API request failed');
                }
            })
            .then(function(result) {
                var eventsArray = result.allEvents || result;
                if (Array.isArray(eventsArray) && eventsArray.length > 0) {
                    events = eventsArray.map(function(event) {
                        return {
                            id: event.id,
                            name: event.name,
                            date: event.eventDate || event.date,
                            attendee_count: event.attendee_count || 0
                        };
                    });
                    console.log('Loaded events from API:', events);
                    showAlert('Successfully connected to backend API!', 'success');
                } else {
                    throw new Error('No events from API');
                }
                populateEventDropdown();
                updateStats();
            })
            .catch(function(error) {
                console.error('API Error:', error);
                // Fallback to sample data
                events = [
                    { id: 1, name: 'Tech Conference 2025', date: '2025-10-15', attendee_count: 150 },
                    { id: 2, name: 'Marketing Summit 2025', date: '2025-11-20', attendee_count: 85 },
                    { id: 3, name: 'Design Workshop 2025', date: '2025-12-05', attendee_count: 45 }
                ];
                populateEventDropdown();
                updateStats();
                showAlert('Using sample data - Backend not connected', 'warning');
            });
        }

        // Populate event dropdowns
        function populateEventDropdown() {
            var eventSelects = [
                document.getElementById('eventFilter'),
                document.getElementById('scannerEventFilter')
            ];
            
            for (var i = 0; i < eventSelects.length; i++) {
                var eventSelect = eventSelects[i];
                if (!eventSelect) continue;
                
                eventSelect.innerHTML = '<option value="">Select an event...</option>';
                
                for (var j = 0; j < events.length; j++) {
                    var event = events[j];
                    var option = document.createElement('option');
                    option.value = event.id;
                    var eventDate = new Date(event.date).toLocaleDateString();
                    var attendeeCount = event.attendee_count || 0;
                    option.textContent = event.name + ' - ' + eventDate + ' (' + attendeeCount + ' attendees)';
                    eventSelect.appendChild(option);
                }
            }
        }

        // Handle event selection change (Print tab)
        function onEventChange() {
            var eventId = document.getElementById('eventFilter').value;
            var attendeeContainer = document.getElementById('attendeeContainer');
            var searchInput = document.getElementById('print-attendee-search');
            
            // Clear search when changing events
            if (searchInput) {
                searchInput.value = '';
            }
            
            if (!eventId) {
                attendeeContainer.innerHTML = '<div class="text-center text-gray-500"><i class="fas fa-calendar-plus text-2xl mb-2"></i><p>Select an event to view attendees</p></div>';
                allAttendees = [];
                selectedAttendees = [];
                currentEvent = null;
                
                // Hide current event statistics row
                var currentEventRow = document.getElementById('currentEventRow');
                if (currentEventRow) {
                    currentEventRow.classList.add('hidden');
                    currentEventRow.classList.remove('flex');
                }
                
                updateButtons();
                updateNewAttendeeFormState();
                return;
            }

            currentEvent = events.find(function(e) { return e.id == eventId; });
            
            showLoading();
            
            loadAttendeesForEvent(eventId)
                .then(function(attendees) {
                    allAttendees = attendees;
                    selectedAttendees = [];
                    displayAttendees();
                    updateButtons();
                    updateNewAttendeeFormState();
                    
                    // Show and update current event statistics
                    var currentEventRow = document.getElementById('currentEventRow');
                    var currentEventAttendees = document.getElementById('currentEventAttendees');
                    if (currentEventRow && currentEventAttendees) {
                        currentEventRow.classList.remove('hidden');
                        currentEventRow.classList.add('flex');
                        currentEventAttendees.textContent = attendees.length;
                    }
                    
                    hideLoading();
                })
                .catch(function(error) {
                    console.error('Error loading attendees:', error);
                    showAlert('Error loading attendees for this event.', 'error');
                    
                    // Hide current event row on error
                    var currentEventRow = document.getElementById('currentEventRow');
                    if (currentEventRow) {
                        currentEventRow.classList.add('hidden');
                        currentEventRow.classList.remove('flex');
                    }
                    
                    hideLoading();
                });
        }

        // Handle event selection change (Scanner tab)
        function onScannerEventChange() {
            var eventId = document.getElementById('scannerEventFilter').value;
            var startScanButton = document.getElementById('start-scan');
            var attendeeListContainer = document.getElementById('scanner-attendee-list');
            
            // Hide any previously scanned attendee data when changing events
            hideScannedAttendeeData();
            
            if (!eventId) {
                startScanButton.disabled = true;
                startScanButton.innerHTML = '<i class="fas fa-play mr-2"></i>Select Event First';
                attendeeListContainer.innerHTML = '<div class="text-center py-8 text-gray-500"><i class="fas fa-calendar-plus text-2xl mb-2"></i><p>Select an event to view attendees</p></div>';
                return;
            }

            currentEvent = events.find(function(e) { return e.id == eventId; });
            
            loadAttendeesForEvent(eventId)
                .then(function(attendees) {
                    allAttendees = attendees;
                    startScanButton.disabled = false;
                    startScanButton.innerHTML = '<i class="fas fa-play mr-2"></i>Start Scanner';
                    displayScannerAttendeeList();
                    console.log('Scanner ready for event ' + eventId + ' with ' + attendees.length + ' attendees');
                })
                .catch(function(error) {
                    console.error('Error loading attendees for scanner:', error);
                    showAlert('Error loading event data for scanner.', 'error');
                    startScanButton.disabled = true;
                    attendeeListContainer.innerHTML = '<div class="text-center py-8 text-red-500"><i class="fas fa-exclamation-triangle text-2xl mb-2"></i><p>Error loading attendees</p></div>';
                });
        }

        // Load attendees for event
        function loadAttendeesForEvent(eventId) {
            return new Promise(function(resolve, reject) {
                console.log('Loading attendees for event ID:', eventId);
                
                // Load attendees filtered by event ID using query parameter
                fetch(API_BASE_URL + '/attendees?eventId=' + eventId, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    mode: 'cors'
                })
                .then(function(response) {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error('Failed to load attendees for event ' + eventId);
                    }
                })
                .then(function(result) {
                    if (result.allAttendees && Array.isArray(result.allAttendees)) {
                        var processedAttendees = result.allAttendees.map(function(attendee) {
                            return {
                                id: attendee.id,
                                full_name: attendee.full_name || (attendee.firstName + ' ' + attendee.lastName),
                                email: attendee.email,
                                company: attendee.company || '',
                                jobTitle: attendee.jobTitle || '',
                                phone: attendee.phone || '',
                                event_id: attendee.eventId || attendee.event_id,
                                checked_in_at: attendee.checked_in_at || null
                            };
                        });
                        
                        console.log('Successfully loaded ' + processedAttendees.length + ' attendees for event ' + eventId);
                        resolve(processedAttendees);
                    } else {
                        throw new Error('Invalid response format from API');
                    }
                })
                .catch(function(error) {
                    console.error('API Error loading attendees for event ' + eventId + ':', error);
                    
                    // Fallback to sample data specific to this event
                    var sampleAttendees = generateSampleAttendees(eventId);
                    console.log('Using sample data: ' + sampleAttendees.length + ' attendees for event ' + eventId);
                    resolve(sampleAttendees);
                });
            });
        }

        // Generate sample attendees for fallback
        function generateSampleAttendees(eventId) {
            var event = events.find(function(e) { return e.id == eventId; });
            var sampleAttendees = [];
            var names = ['John Doe', 'Jane Smith', 'Bob Johnson', 'Alice Brown', 'Charlie Wilson'];
            var companies = ['Tech Corp', 'Design Studio', 'Marketing Inc', 'Startup LLC', 'Enterprise Co'];
            var jobTitles = ['Software Engineer', 'Marketing Manager', 'Design Director', 'Product Manager', 'Sales Executive'];
            
            var count = Math.min(event ? event.attendee_count || 10 : 10, 20);
            var startId = parseInt(eventId) * 1000; // Make unique IDs per event
            
            for (var i = 1; i <= count; i++) {
                sampleAttendees.push({
                    id: startId + i,
                    full_name: names[(i-1) % names.length] + ' ' + i + ' (Event ' + eventId + ')',
                    email: 'attendee' + (startId + i) + '@example.com',
                    company: companies[(i-1) % companies.length],
                    jobTitle: jobTitles[(i-1) % jobTitles.length],
                    phone: '+1555000' + String(startId + i).padStart(4, '0'),
                    event_id: parseInt(eventId),
                    checked_in_at: null
                });
            }
            
            console.log('Generated ' + sampleAttendees.length + ' sample attendees for event ' + eventId);
            return sampleAttendees;
        }

        // Display attendees list
        function displayAttendees() {
            var container = document.getElementById('attendeeContainer');
            
            if (!allAttendees || allAttendees.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500"><i class="fas fa-users text-2xl mb-2"></i><p>No attendees found for this event</p></div>';
                return;
            }
            
            renderPrintAttendeeList(allAttendees);
        }

        // Filter attendee list for print tab based on search input
        function filterPrintAttendeeList() {
            var searchTerm = document.getElementById('print-attendee-search').value.toLowerCase().trim();
            
            if (!allAttendees || allAttendees.length === 0) {
                return;
            }
            
            var filteredAttendees = allAttendees;
            
            if (searchTerm) {
                filteredAttendees = allAttendees.filter(function(attendee) {
                    var fullName = attendee.full_name || (attendee.firstName && attendee.lastName ? attendee.firstName + ' ' + attendee.lastName : '');
                    var email = attendee.email || '';
                    var company = attendee.company || '';
                    
                    return fullName.toLowerCase().includes(searchTerm) ||
                           email.toLowerCase().includes(searchTerm) ||
                           company.toLowerCase().includes(searchTerm);
                });
            }
            
            renderPrintAttendeeList(filteredAttendees);
        }

        // Render the attendee list for print tab
        function renderPrintAttendeeList(attendees) {
            var container = document.getElementById('attendeeContainer');
            
            if (attendees.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500"><i class="fas fa-search text-2xl mb-2"></i><p>No attendees match your search</p></div>';
                return;
            }
            
            var html = '<div class="space-y-2">';
            
            for (var i = 0; i < attendees.length; i++) {
                var attendee = attendees[i];
                var isSelected = selectedAttendees.some(function(selected) { return selected.id === attendee.id; });
                var checkedInStatus = attendee.checked_in_at ? 'Checked In' : 'Not Checked In';
                var statusClass = attendee.checked_in_at ? 'text-green-600 bg-green-50' : 'text-yellow-600 bg-yellow-50';
                var statusIcon = attendee.checked_in_at ? 'fa-check-circle' : 'fa-clock';
                
                html += '<div class="flex items-center justify-between p-3 hover:bg-white rounded-lg border ' + (isSelected ? 'border-blue-300 bg-blue-50' : 'border-gray-200') + ' transition duration-200">';
                html += '<div class="flex items-center space-x-3 flex-1 min-w-0">';
                html += '<input type="checkbox" id="attendee-' + attendee.id + '" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" ' + (isSelected ? 'checked' : '') + ' onchange="toggleAttendeeSelection(' + attendee.id + ')">';
                html += '<div class="flex-1 min-w-0">';
                html += '<div class="font-medium text-gray-900 text-sm">' + attendee.full_name + '</div>';
                html += '<div class="text-xs text-gray-500 mt-1">' + attendee.email + '</div>';
                if (attendee.jobTitle) {
                    html += '<div class="text-xs text-blue-600 mt-1 font-medium">' + attendee.jobTitle + '</div>';
                }
                if (attendee.company) {
                    html += '<div class="text-xs text-gray-400 mt-1">' + attendee.company + '</div>';
                }
                html += '</div>';
                html += '</div>';
                html += '<div class="flex items-center space-x-2">';
                html += '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ' + statusClass + '">';
                html += '<i class="fas ' + statusIcon + ' mr-1"></i>' + checkedInStatus;
                html += '</span>';
                html += '<button onclick="editAttendee(' + attendee.id + ')" class="bg-gray-500 hover:bg-gray-600 text-white text-xs font-medium py-1 px-2 rounded transition duration-200" title="Edit Attendee">';
                html += '<i class="fas fa-edit"></i>';
                html += '</button>';
                if (!isSelected) {
                    html += '<button onclick="selectSingleAttendee(' + attendee.id + ')" class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium py-1 px-2 rounded transition duration-200">';
                    html += '<i class="fas fa-plus mr-1"></i>Select';
                    html += '</button>';
                }
                html += '</div>';
                html += '</div>';
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Toggle attendee selection
        function toggleAttendeeSelection(attendeeId) {
            var attendee = allAttendees.find(function(a) { return a.id === attendeeId; });
            var index = selectedAttendees.findIndex(function(a) { return a.id === attendeeId; });
            
            if (index > -1) {
                selectedAttendees.splice(index, 1);
            } else {
                selectedAttendees.push(attendee);
            }
            
            // Auto-generate badges when attendees are selected
            autoGenerateBadges();
            updateButtons();
            // Refresh the display to show updated selection state
            filterPrintAttendeeList();
        }

        // Select single attendee (quick select button)
        function selectSingleAttendee(attendeeId) {
            var attendee = allAttendees.find(function(a) { return a.id === attendeeId; });
            var index = selectedAttendees.findIndex(function(a) { return a.id === attendeeId; });
            
            if (index === -1) {
                selectedAttendees.push(attendee);
                // Auto-generate badges when attendees are selected
                autoGenerateBadges();
                updateButtons();
                filterPrintAttendeeList();
                showAlert('Added ' + attendee.full_name + ' to selection and generated badge.', 'success');
            }
        }

        // Select all attendees (visible ones after search)
        function selectAllAttendees() {
            if (!allAttendees || allAttendees.length === 0) {
                showAlert('No attendees available to select.', 'warning');
                return;
            }
            
            // Get currently visible attendees (after search filter)
            var searchTerm = document.getElementById('print-attendee-search').value.toLowerCase().trim();
            var visibleAttendees = allAttendees;
            
            if (searchTerm) {
                visibleAttendees = allAttendees.filter(function(attendee) {
                    var fullName = attendee.full_name || (attendee.firstName && attendee.lastName ? attendee.firstName + ' ' + attendee.lastName : '');
                    var email = attendee.email || '';
                    var company = attendee.company || '';
                    
                    return fullName.toLowerCase().includes(searchTerm) ||
                           email.toLowerCase().includes(searchTerm) ||
                           company.toLowerCase().includes(searchTerm);
                });
            }
            
            // Add visible attendees to selection (avoid duplicates)
            for (var i = 0; i < visibleAttendees.length; i++) {
                var attendee = visibleAttendees[i];
                var isAlreadySelected = selectedAttendees.some(function(selected) { 
                    return selected.id === attendee.id; 
                });
                if (!isAlreadySelected) {
                    selectedAttendees.push(attendee);
                }
            }
            
            // Auto-generate badges for all selected attendees
            autoGenerateBadges();
            filterPrintAttendeeList();
            updateButtons();
            showAlert('Selected ' + visibleAttendees.length + ' attendees and generated badges' + (searchTerm ? ' (from search results)' : '') + '.', 'success');
        }

        // Clear selection
        function clearSelection() {
            selectedAttendees = [];
            // Auto-clear badges when selection is cleared
            autoGenerateBadges();
            filterPrintAttendeeList();
            updateButtons();
            showAlert('Selection and badges cleared.', 'info');
        }

        // Toggle new attendee form visibility
        function toggleNewAttendeeForm() {
            var form = document.getElementById('newAttendeeForm');
            var toggleBtn = document.getElementById('toggleNewAttendeeBtn');
            
            if (form.classList.contains('hidden')) {
                form.classList.remove('hidden');
                toggleBtn.innerHTML = '<i class="fas fa-minus mr-1"></i>Cancel';
                toggleBtn.classList.remove('text-blue-600', 'hover:text-blue-800');
                toggleBtn.classList.add('text-red-600', 'hover:text-red-800');
            } else {
                form.classList.add('hidden');
                toggleBtn.innerHTML = '<i class="fas fa-plus mr-1"></i>Add New';
                toggleBtn.classList.remove('text-red-600', 'hover:text-red-800');
                toggleBtn.classList.add('text-blue-600', 'hover:text-blue-800');
                clearNewAttendeeForm();
            }
        }

        // Clear new attendee form
        function clearNewAttendeeForm() {
            document.getElementById('newAttendeeFullName').value = '';
            document.getElementById('newAttendeeEmail').value = '';
            document.getElementById('newAttendeeJobTitle').value = '';
            document.getElementById('newAttendeeCompany').value = '';
            document.getElementById('newAttendeePhone').value = '';
            
            // Hide form if it's visible
            var form = document.getElementById('newAttendeeForm');
            var toggleBtn = document.getElementById('toggleNewAttendeeBtn');
            if (!form.classList.contains('hidden')) {
                form.classList.add('hidden');
                toggleBtn.innerHTML = '<i class="fas fa-plus mr-1"></i>Add New';
                toggleBtn.classList.remove('text-red-600', 'hover:text-red-800');
                toggleBtn.classList.add('text-blue-600', 'hover:text-blue-800');
            }
        }

        // Global variable to store the attendee being edited
        var editingAttendee = null;

        // Edit attendee function
        function editAttendee(attendeeId) {
            var attendee = allAttendees.find(function(a) { return a.id === attendeeId; });
            if (!attendee) {
                showAlert('Attendee not found.', 'error');
                return;
            }
            
            editingAttendee = attendee;
            
            // Populate the edit form
            document.getElementById('editFirstName').value = attendee.firstName || attendee.full_name?.split(' ')[0] || '';
            document.getElementById('editLastName').value = attendee.lastName || attendee.full_name?.split(' ').slice(1).join(' ') || '';
            document.getElementById('editEmail').value = attendee.email || '';
            document.getElementById('editJobTitle').value = attendee.jobTitle || '';
            document.getElementById('editCompany').value = attendee.company || '';
            document.getElementById('editPhone').value = attendee.phone || '';
            
            // Update modal title
            document.getElementById('editModalTitle').textContent = 'Edit ' + (attendee.full_name || attendee.firstName + ' ' + attendee.lastName);
            
            // Show the modal
            document.getElementById('editAttendeeModal').classList.remove('hidden');
        }

        // Close edit modal
        function closeEditModal() {
            document.getElementById('editAttendeeModal').classList.add('hidden');
            editingAttendee = null;
            
            // Clear form
            document.getElementById('editAttendeeForm').reset();
        }

        // Save attendee edit
        function saveAttendeeEdit() {
            if (!editingAttendee) {
                showAlert('No attendee selected for editing.', 'error');
                return;
            }
            
            // Get form data
            var firstName = document.getElementById('editFirstName').value.trim();
            var lastName = document.getElementById('editLastName').value.trim();
            var email = document.getElementById('editEmail').value.trim();
            var jobTitle = document.getElementById('editJobTitle').value.trim();
            var company = document.getElementById('editCompany').value.trim();
            var phone = document.getElementById('editPhone').value.trim();
            
            // Validate required fields
            if (!firstName || !lastName || !email || !jobTitle || !company || !phone) {
                showAlert('All fields are required.', 'warning');
                return;
            }
            
            // Validate email format
            var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showAlert('Please enter a valid email address.', 'warning');
                return;
            }
            
            // Check if email is already used by another attendee
            var existingAttendee = allAttendees.find(function(a) { 
                return a.id !== editingAttendee.id && a.email.toLowerCase() === email.toLowerCase(); 
            });
            if (existingAttendee) {
                showAlert('This email is already used by another attendee.', 'warning');
                return;
            }
            
            // Prepare update data
            var updateData = {
                firstName: firstName,
                lastName: lastName,
                email: email,
                jobTitle: jobTitle,
                company: company,
                phone: phone
            };
            
            // Show loading state
            showAlert('Updating attendee information...', 'info');
            
            // Send update to backend API
            fetch(API_BASE_URL + '/attendees/' + editingAttendee.id, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updateData)
            })
            .then(function(response) {
                if (response.ok) {
                    return response.json();
                }
                throw new Error('Failed to update attendee');
            })
            .then(function(updatedAttendee) {
                // Update the attendee in local arrays
                var attendeeIndex = allAttendees.findIndex(function(a) { return a.id === editingAttendee.id; });
                if (attendeeIndex !== -1) {
                    // Update properties
                    allAttendees[attendeeIndex].firstName = firstName;
                    allAttendees[attendeeIndex].lastName = lastName;
                    allAttendees[attendeeIndex].full_name = firstName + ' ' + lastName;
                    allAttendees[attendeeIndex].email = email;
                    allAttendees[attendeeIndex].jobTitle = jobTitle;
                    allAttendees[attendeeIndex].company = company;
                    allAttendees[attendeeIndex].phone = phone;
                }
                
                // Update in selected attendees if present
                var selectedIndex = selectedAttendees.findIndex(function(a) { return a.id === editingAttendee.id; });
                if (selectedIndex !== -1) {
                    selectedAttendees[selectedIndex].firstName = firstName;
                    selectedAttendees[selectedIndex].lastName = lastName;
                    selectedAttendees[selectedIndex].full_name = firstName + ' ' + lastName;
                    selectedAttendees[selectedIndex].email = email;
                    selectedAttendees[selectedIndex].jobTitle = jobTitle;
                    selectedAttendees[selectedIndex].company = company;
                    selectedAttendees[selectedIndex].phone = phone;
                }
                
                // Refresh the attendee list display
                filterPrintAttendeeList();
                
                // If this attendee has badges generated, refresh them
                var existingBadges = document.querySelectorAll('.badge-a6');
                var hasExistingBadge = false;
                for (var i = 0; i < existingBadges.length; i++) {
                    var badgeAttendeeId = existingBadges[i].getAttribute('data-attendee-id');
                    if (badgeAttendeeId == editingAttendee.id) {
                        hasExistingBadge = true;
                        break;
                    }
                }
                
                if (hasExistingBadge) {
                    displayBadges(selectedAttendees);
                }
                
                closeEditModal();
                showAlert('Attendee information updated successfully!', 'success');
            })
            .catch(function(error) {
                console.error('Error updating attendee:', error);
                showAlert('Failed to update attendee information. Please try again.', 'error');
            });
        }

        // Create new attendee
        function createNewAttendee() {
            if (!currentEvent || !currentEvent.id) {
                showAlert('Please select an event first.', 'warning');
                return;
            }

            // Get form values
            var fullName = document.getElementById('newAttendeeFullName').value.trim();
            var email = document.getElementById('newAttendeeEmail').value.trim();
            var jobTitle = document.getElementById('newAttendeeJobTitle').value.trim();
            var company = document.getElementById('newAttendeeCompany').value.trim();
            var phone = document.getElementById('newAttendeePhone').value.trim();

            // Validate required fields
            if (!fullName || !email || !jobTitle || !company || !phone) {
                showAlert('Please fill in all required fields (Full Name, Email, Job Title, Company, and Phone Number).', 'warning');
                return;
            }

            // Validate email format
            var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showAlert('Please enter a valid email address.', 'warning');
                return;
            }

            // Check if attendee already exists in current event
            if (allAttendees && allAttendees.some(function(attendee) {
                var attendeeEmail = attendee.email || '';
                return attendeeEmail.toLowerCase() === email.toLowerCase();
            })) {
                showAlert('An attendee with this email already exists for this event.', 'warning');
                return;
            }

            // Split full name into first and last name
            var nameParts = fullName.split(' ');
            var firstName = nameParts[0];
            var lastName = nameParts.slice(1).join(' ');
            
            // If no last name provided, use a default or require it
            if (!lastName || lastName.trim() === '') {
                showAlert('Please enter both first name and last name (e.g., "John Doe")', 'error');
                return;
            }

            // Prepare attendee data
            var newAttendeeData = {
                firstName: firstName,
                lastName: lastName,
                email: email,
                jobTitle: jobTitle,
                company: company,
                phone: phone,
                eventId: parseInt(currentEvent.id, 10), // Ensure it's a number
                country: undefined
            };

            // Show loading state
            showAlert('Creating new attendee...', 'info');

            // Debug: Log the data being sent
            console.log('Creating attendee with data:', newAttendeeData);
            console.log('First name:', firstName, 'Last name:', lastName);
            console.log('Full name parts:', nameParts);
            console.log('Current event:', currentEvent);

            // Send to backend API
            fetch(API_BASE_URL + '/attendees', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(newAttendeeData)
            })
            .then(function(response) {
                if (!response.ok) {
                    return response.text().then(function(errorText) {
                        console.error('Server response:', response.status, response.statusText);
                        console.error('Error details:', errorText);
                        
                        try {
                            var errorData = JSON.parse(errorText);
                            throw new Error(errorData.message || errorData.error || 'Failed to create attendee');
                        } catch (parseError) {
                            throw new Error('Server error: ' + response.status + ' - ' + errorText);
                        }
                    });
                }
                return response.json();
            })
            .then(function(response) {
                var createdAttendee = response.createdAttendee;
                
                // Add to local attendees list
                if (!allAttendees) {
                    allAttendees = [];
                }
                allAttendees.push(createdAttendee);

                // Clear form and hide it
                clearNewAttendeeForm();

                // Refresh attendee list display
                filterPrintAttendeeList();

                // Auto-select the new attendee
                selectSingleAttendee(createdAttendee.id);

                showAlert('Attendee "' + fullName + '" created successfully and selected for badge printing!', 'success');
            })
            .catch(function(error) {
                console.error('Error creating attendee:', error);
                showAlert('Failed to create attendee: ' + error.message, 'error');
            });
        }

        // Update new attendee form state based on event selection
        function updateNewAttendeeFormState() {
            var addNewBtn = document.getElementById('toggleNewAttendeeBtn');
            var form = document.getElementById('newAttendeeForm');
            
            if (!currentEvent) {
                // Disable the add new button and hide form
                addNewBtn.style.opacity = '0.5';
                addNewBtn.style.pointerEvents = 'none';
                addNewBtn.title = 'Please select an event first';
                
                if (!form.classList.contains('hidden')) {
                    clearNewAttendeeForm();
                }
            } else {
                // Enable the add new button
                addNewBtn.style.opacity = '1';
                addNewBtn.style.pointerEvents = 'auto';
                addNewBtn.title = 'Add new attendee to ' + currentEvent.name;
            }
        }

        // Update button states and stats
        function updateButtons() {
            var hasSelection = selectedAttendees.length > 0;
            var printButton = document.getElementById('printButton');
            
            printButton.disabled = !hasSelection;
            
            // Update button text
            if (hasSelection) {
                printButton.innerHTML = '<i class="fas fa-print mr-2"></i>Print ' + selectedAttendees.length + ' Badge' + (selectedAttendees.length > 1 ? 's' : '');
            } else {
                printButton.innerHTML = '<i class="fas fa-print mr-2"></i>Print Badges';
            }
            
            // Update real-time stats
            document.getElementById('selectedCount').textContent = selectedAttendees.length;
            document.getElementById('generatedCount').textContent = document.querySelectorAll('.badge-a6').length;
            
            // Update total attendees for current event if available
            if (currentEvent && allAttendees) {
                // This shows attendees for the current event, not global total
                var currentEventElement = document.getElementById('currentEventAttendees');
                if (currentEventElement) {
                    currentEventElement.textContent = allAttendees.length;
                }
            }
        }

        // Auto-generate badges when attendees are selected
        function autoGenerateBadges() {
            if (selectedAttendees.length === 0) {
                clearPreview();
                return;
            }
            
            // Generate badges immediately
            displayBadges(selectedAttendees);
            document.getElementById('generatedCount').textContent = selectedAttendees.length;
        }



        // Manual generate badges (kept for compatibility but now just calls auto-generate)
        function generateBadges() {
            if (selectedAttendees.length === 0) {
                showAlert('Please select attendees to generate badges for.', 'warning');
                return;
            }
            
            autoGenerateBadges();
            showAlert('Generated ' + selectedAttendees.length + ' badges successfully!', 'success');
        }

        // Generate badges for printing (hidden container)
        function displayBadges(attendeeList) {
            // Create or get hidden container for badges
            var container = document.getElementById('hiddenBadgesContainer');
            if (!container) {
                container = document.createElement('div');
                container.id = 'hiddenBadgesContainer';
                container.style.display = 'none';
                document.body.appendChild(container);
            }
            
            var html = '';
            for (var i = 0; i < attendeeList.length; i++) {
                var attendee = attendeeList[i];
                html += generateBadgeHTML(attendee);
            }
            
            container.innerHTML = html;
            
            // Show QR generation progress for larger batches
            if (attendeeList.length > 10) {
                showQRGenerationProgress(attendeeList);
            } else {
                // Generate QR codes for each badge
                for (var i = 0; i < attendeeList.length; i++) {
                    generateQRCodeForBadge(attendeeList[i]);
                }
            }
        }

        // Generate individual badge HTML - A6 Format (105mm x 148mm)
        function generateBadgeHTML(attendee) {
            var eventName = currentEvent ? currentEvent.name : 'Event Badge';
            var eventDate = currentEvent ? new Date(currentEvent.date).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            }) : '';
            
            // Extract title from attendee data (if available) or use default
            var attendeeTitle = attendee.jobTitle || attendee.title || 'Participant';
            var attendeeCompany = attendee.company || 'Organization';
            
            return '<div class="badge-a6 bg-white border-2 border-gray-300 rounded-lg overflow-hidden shadow-lg" id="badge-' + attendee.id + '" style="width: 4.13in; height: 5.83in; page-break-inside: avoid; margin: 0.25in;">' +
                // Header Section with Organization Branding
                '<div class="bg-gradient-to-r from-blue-700 to-blue-900 text-white p-6 text-center">' +
                    '<div class="w-20 h-20 bg-white rounded-full mx-auto mb-3 flex items-center justify-center">' +
                        '<i class="fas fa-building text-blue-700 text-3xl"></i>' +
                    '</div>' +
                    '<h2 class="text-2xl font-bold tracking-wide mb-1">GHSO</h2>' +
                    '<p class="text-sm opacity-90 font-medium">Event Registration</p>' +
                    '<div class="mt-3 pt-3 border-t border-blue-600">' +
                        '<h3 class="text-lg font-bold mb-1">' + eventName + '</h3>' +
                        '<p class="text-sm opacity-90">' + eventDate + '</p>' +
                    '</div>' +
                '</div>' +
                
                // Attendee Information - Prominently Displayed
                '<div class="px-6 py-8 text-center bg-white">' +
                    '<h4 class="text-3xl font-bold text-gray-900 mb-4 leading-tight">' + attendee.full_name + '</h4>' +
                    '<div class="mb-4">' +
                        '<p class="text-xl text-blue-700 font-semibold mb-2">' + attendeeTitle + '</p>' +
                        '<p class="text-lg text-gray-700 font-medium">' + attendeeCompany + '</p>' +
                    '</div>' +
                '</div>' +
                
                // QR Code Section
                '<div class="flex justify-center py-6 bg-gray-50 border-t">' +
                    '<div class="text-center">' +
                        '<div id="qr-' + attendee.id + '" class="qr-code w-24 h-24 border-2 border-gray-300 bg-white mx-auto mb-3 flex items-center justify-center">' +
                            '<span class="text-xs text-gray-400">QR Code</span>' +
                        '</div>' +
                        '<p class="text-sm text-gray-600 font-medium">Scan for Identification</p>' +
                        '<p class="text-xs text-gray-500 mt-1">ID: #' + String(attendee.id).padStart(4, '0') + '</p>' +
                    '</div>' +
                '</div>' +
            '</div>';
        }



        // Generate QR code for badge
        function generateQRCodeForBadge(attendee) {
            try {
                var qrData = JSON.stringify({
                    id: attendee.id,
                    name: attendee.full_name,
                    email: attendee.email,
                    event: currentEvent ? currentEvent.name : 'Event'
                });
                
                var qrElement = document.getElementById('qr-' + attendee.id);
                if (!qrElement) {
                    console.error('QR element not found for attendee:', attendee.id);
                    return;
                }
                
                // Enhanced QR library detection with multiple fallback attempts
                var qrGenerated = false;
                
                // Method 1: Try qrcode.js library (QRCode.toCanvas)
                if (typeof QRCode !== 'undefined' && typeof QRCode.toCanvas === 'function') {
                    try {
                        qrElement.innerHTML = '';
                        QRCode.toCanvas(qrElement, qrData, {
                            width: 92,
                            height: 92,
                            margin: 1,
                            color: {
                                dark: '#000000',
                                light: '#FFFFFF'
                            },
                            errorCorrectionLevel: 'M'
                        }, function (error) {
                            if (error) {
                                console.error('QR canvas generation error:', error);
                                generateQRCodeFallback(qrElement, qrData, attendee.id);
                            } else {
                                console.log('QR code generated via canvas for attendee:', attendee.id);
                            }
                        });
                        qrGenerated = true;
                    } catch (canvasError) {
                        console.warn('Canvas QR generation failed:', canvasError);
                    }
                }
                
                // Method 2: Try qrcode-generator library (new QRCode constructor)
                if (!qrGenerated && typeof QRCode !== 'undefined' && typeof QRCode === 'function') {
                    try {
                        qrElement.innerHTML = '';
                        var qr = new QRCode(qrElement, {
                            text: qrData,
                            width: 92,
                            height: 92,
                            colorDark: '#000000',
                            colorLight: '#ffffff',
                            correctLevel: QRCode.CorrectLevel ? QRCode.CorrectLevel.M : 0
                        });
                        qrGenerated = true;
                        console.log('QR code generated via constructor for attendee:', attendee.id);
                    } catch (constructorError) {
                        console.warn('Constructor QR generation failed:', constructorError);
                    }
                }
                
                // Method 3: Try window.QRCode (alternative namespace)
                if (!qrGenerated && typeof window.QRCode !== 'undefined') {
                    try {
                        qrElement.innerHTML = '';
                        var qr = new window.QRCode(qrElement, {
                            text: qrData,
                            width: 92,
                            height: 92,
                            colorDark: '#000000',
                            colorLight: '#ffffff'
                        });
                        qrGenerated = true;
                        console.log('QR code generated via window.QRCode for attendee:', attendee.id);
                    } catch (windowError) {
                        console.warn('Window QR generation failed:', windowError);
                    }
                }
                
                // Fallback: Use online QR service
                if (!qrGenerated) {
                    console.warn('All QR libraries failed, using online fallback for attendee:', attendee.id);
                    generateQRCodeFallback(qrElement, qrData, attendee.id);
                }
                
            } catch (error) {
                console.error('Error generating QR code:', error);
                var qrElement = document.getElementById('qr-' + attendee.id);
                if (qrElement) {
                    generateQRCodeFallback(qrElement, qrData, attendee.id);
                }
            }
        }

        // Fallback QR code generation using online service
        function generateQRCodeFallback(qrElement, qrData, attendeeId) {
            try {
                // First try with QR Server API
                var encodedData = encodeURIComponent(qrData);
                var qrImageUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=92x92&data=' + encodedData + '&ecc=M&margin=1';
                
                // Create image element with multiple fallbacks
                var img = document.createElement('img');
                img.src = qrImageUrl;
                img.alt = 'QR Code';
                img.style.cssText = 'width: 92px; height: 92px; border: 1px solid #ccc; display: block;';
                
                // Handle image load success
                img.onload = function() {
                    qrElement.innerHTML = '';
                    qrElement.appendChild(img);
                    console.log('Fallback QR code loaded successfully for attendee:', attendeeId);
                };
                
                // Handle image load error - try alternative service
                img.onerror = function() {
                    console.warn('Primary QR service failed, trying alternative for attendee:', attendeeId);
                    
                    // Try alternative QR service
                    var altQrUrl = 'https://chart.googleapis.com/chart?chs=92x92&cht=qr&chl=' + encodedData + '&choe=UTF-8';
                    var altImg = document.createElement('img');
                    altImg.src = altQrUrl;
                    altImg.alt = 'QR Code';
                    altImg.style.cssText = 'width: 92px; height: 92px; border: 1px solid #ccc; display: block;';
                    
                    altImg.onload = function() {
                        qrElement.innerHTML = '';
                        qrElement.appendChild(altImg);
                        console.log('Alternative QR service succeeded for attendee:', attendeeId);
                    };
                    
                    altImg.onerror = function() {
                        console.error('All QR services failed for attendee:', attendeeId);
                        handleQRError(attendeeId);
                    };
                };
                
                // Show loading state initially
                qrElement.innerHTML = '<div style="width: 92px; height: 92px; border: 1px solid #ccc; display: flex; align-items: center; justify-content: center; font-size: 10px; text-align: center; background: #f8f9fa; color: #6c757d;"><i class="fas fa-spinner fa-spin"></i><br>Loading...</div>';
                
            } catch (error) {
                console.error('Fallback QR generation failed:', error);
                handleQRError(attendeeId);
            }
        }

        // Handle QR image loading errors
        function handleQRError(attendeeId) {
            var qrElement = document.getElementById('qr-' + attendeeId);
            if (qrElement) {
                // Create a simple text-based QR representation as last resort
                var attendeeData = selectedAttendees.find(function(a) { return a.id === attendeeId; });
                var fallbackText = attendeeData ? 'ID: ' + attendeeId : 'ID: ' + attendeeId;
                
                qrElement.innerHTML = '<div style="width: 92px; height: 92px; border: 2px solid #dc3545; display: flex; align-items: center; justify-content: center; font-size: 8px; text-align: center; background: #f8d7da; color: #721c24; border-radius: 4px; flex-direction: column;">' +
                    '<i class="fas fa-exclamation-triangle" style="font-size: 16px; margin-bottom: 4px;"></i>' +
                    '<div style="font-weight: bold;">QR Error</div>' +
                    '<div style="font-size: 7px; margin-top: 2px;">' + fallbackText + '</div>' +
                '</div>';
                
                console.error('QR code generation completely failed for attendee:', attendeeId);
            }
        }

        // Print badges in A6 format
        function printBadges() {
            var badges = document.querySelectorAll('.badge-a6');
            if (badges.length === 0) {
                showAlert('No badges to print. Please generate badges first.', 'warning');
                return;
            }
            
            // Prepare for A6 printing
            showAlert('Preparing ' + badges.length + ' badge(s) for A6 printing...', 'info');
            
            // Ensure QR codes are fully rendered before printing
            var allQRsRendered = true;
            badges.forEach(function(badge) {
                var qrElement = badge.querySelector('.qr-code');
                var qrCanvas = qrElement ? qrElement.querySelector('canvas') : null;
                var qrImage = qrElement ? qrElement.querySelector('img') : null;
                var qrDiv = qrElement ? qrElement.querySelector('div') : null;
                
                // Check if any QR representation exists (canvas, image, or div)
                if (!qrCanvas && !qrImage && !qrDiv) {
                    allQRsRendered = false;
                }
            });
            
            if (!allQRsRendered) {
                showAlert('QR codes are still generating. Please wait and try again.', 'warning');
                return;
            }
            
            // Show hidden badges container for printing
            var hiddenContainer = document.getElementById('hiddenBadgesContainer');
            if (hiddenContainer) {
                hiddenContainer.style.display = 'block';
            }
            
            // Add print-specific classes
            document.body.classList.add('printing');
            
            // Trigger print with proper timing
            setTimeout(function() {
                window.print();
                
                // Remove print classes and hide container after printing
                setTimeout(function() {
                    document.body.classList.remove('printing');
                    if (hiddenContainer) {
                        hiddenContainer.style.display = 'none';
                    }
                }, 1000);
            }, 200);
        }

        // Clear preview
        function clearPreview() {
            // Clear hidden badges container
            var container = document.getElementById('hiddenBadgesContainer');
            if (container) {
                container.innerHTML = '';
            }
            
            document.getElementById('generatedCount').textContent = '0';
        }



        // Show QR generation progress for large batches
        function showQRGenerationProgress(attendeeList) {
            var processed = 0;
            var total = attendeeList.length;
            
            // Show initial progress
            showAlert('Generating QR codes: 0/' + total, 'info');
            
            // Process QR codes in batches with progress updates
            function processNextBatch(startIndex) {
                var batchSize = 5;
                var endIndex = Math.min(startIndex + batchSize, total);
                
                for (var i = startIndex; i < endIndex; i++) {
                    generateQRCodeForBadge(attendeeList[i]);
                    processed++;
                }
                
                // Update progress
                if (processed < total) {
                    showAlert('Generating QR codes: ' + processed + '/' + total, 'info');
                    setTimeout(function() {
                        processNextBatch(endIndex);
                    }, 200);
                } else {
                    showAlert('Generated ' + total + ' badges with QR codes successfully!', 'success');
                }
            }
            
            // Start processing
            setTimeout(function() {
                processNextBatch(0);
            }, 300);
        }

        // QR Scanner functionality
        function startScanning() {
            if (!currentEvent) {
                showAlert('Please select an event first.', 'warning');
                return;
            }
            
            if (typeof Html5Qrcode === 'undefined') {
                showAlert('QR Scanner library not loaded. Please refresh the page.', 'error');
                return;
            }
            
            // Hide any previously scanned attendee data when starting a new scan session
            hideScannedAttendeeData();
            
            html5QrCode = new Html5Qrcode("qr-reader");
            
            const config = {
                fps: 10,
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0
            };
            
            html5QrCode.start(
                { facingMode: "environment" }, // Use back camera
                config,
                onScanSuccess,
                onScanFailure
            ).then(() => {
                document.getElementById('start-scan').classList.add('hidden');
                document.getElementById('stop-scan').classList.remove('hidden');
                scannerActive = true;
                showAlert('QR Scanner started successfully!', 'success');
            }).catch(err => {
                console.error('Failed to start QR scanner:', err);
                showAlert('Failed to start camera. Please check permissions.', 'error');
                
                // Fallback: Try to get available cameras
                Html5Qrcode.getCameras().then(devices => {
                    if (devices && devices.length > 0) {
                        // Try with the first available camera
                        html5QrCode.start(
                            devices[0].id,
                            config,
                            onScanSuccess,
                            onScanFailure
                        ).then(() => {
                            document.getElementById('start-scan').classList.add('hidden');
                            document.getElementById('stop-scan').classList.remove('hidden');
                            scannerActive = true;
                            showAlert('QR Scanner started with fallback camera!', 'success');
                        }).catch(fallbackErr => {
                            console.error('Fallback camera also failed:', fallbackErr);
                            showAlert('Camera access denied or not available. You can use manual input instead.', 'warning');
                        });
                    } else {
                        showAlert('No cameras found. Please use manual input.', 'warning');
                    }
                }).catch(cameraErr => {
                    console.error('Failed to get cameras:', cameraErr);
                    showAlert('Camera access not available. Please use manual input.', 'warning');
                });
            });
        }

        // Stop scanning
        function stopScanning() {
            if (html5QrCode && scannerActive) {
                html5QrCode.stop().then(() => {
                    html5QrCode.clear();
                    html5QrCode = null;
                    scannerActive = false;
                    
                    document.getElementById('start-scan').classList.remove('hidden');
                    document.getElementById('stop-scan').classList.add('hidden');
                    
                    // Reset the scanner area
                    var readerElement = document.getElementById('qr-reader');
                    readerElement.innerHTML = '<div class="text-center"><i class="fas fa-qrcode text-gray-400 text-4xl mb-3"></i><p class="text-gray-500">QR Code Scanner</p><p class="text-xs text-gray-400 mt-1">Scanner stopped</p></div>';
                    
                    showAlert('QR Scanner stopped.', 'info');
                }).catch(err => {
                    console.error('Error stopping scanner:', err);
                    showAlert('Error stopping scanner.', 'warning');
                });
            } else {
                scannerActive = false;
                document.getElementById('start-scan').classList.remove('hidden');
                document.getElementById('stop-scan').classList.add('hidden');
                
                var readerElement = document.getElementById('qr-reader');
                readerElement.innerHTML = '<div class="text-center"><i class="fas fa-qrcode text-gray-400 text-4xl mb-3"></i><p class="text-gray-500">QR Code Scanner</p><p class="text-xs text-gray-400 mt-1">Scanner stopped</p></div>';
            }
        }

        // QR Scan Success Callback
        function onScanSuccess(decodedText, decodedResult) {
            console.log('QR Code scanned:', decodedText);
            
            try {
                // Try to parse as JSON (attendee QR code)
                var qrData = JSON.parse(decodedText);
                
                if (qrData.id && qrData.email) {
                    // Find attendee by ID and email for security
                    var attendee = allAttendees.find(function(a) {
                        var email = a.email || '';
                        return a.id.toString() === qrData.id.toString() && 
                               email.toLowerCase() === qrData.email.toLowerCase();
                    });
                    
                    if (attendee) {
                        processCheckIn(attendee);
                        
                        // Display scanned attendee data in the sidebar
                        displayScannedAttendeeData(attendee, qrData);
                        
                        // Generate and optionally print badge for this attendee
                        setTimeout(function() {
                            displayBadges([attendee]);
                            
                            var autoPrint = document.getElementById('auto-print').checked;
                            if (autoPrint) {
                                setTimeout(function() {
                                    printBadges();
                                    showAlert('Badge generated and printed for ' + (attendee.full_name || (attendee.firstName + ' ' + attendee.lastName)) + '!', 'success');
                                }, 1000);
                            } else {
                                showAlert('Badge generated for ' + (attendee.full_name || (attendee.firstName + ' ' + attendee.lastName)) + '. Click Print to print the badge.', 'success');
                            }
                        }, 500);
                    } else {
                        showAlert('Attendee not found in current event: ' + (qrData.name || qrData.email), 'error');
                        scanStats.failedScans++;
                        updateScanStats();
                    }
                } else {
                    throw new Error('Invalid QR code format');
                }
            } catch (error) {
                console.error('Error parsing QR code:', error);
                
                // Try treating as plain text (email or name)
                var attendee = allAttendees.find(function(a) {
                    var email = a.email || '';
                    var fullName = a.full_name || (a.firstName && a.lastName ? a.firstName + ' ' + a.lastName : '');
                    
                    return email.toLowerCase() === decodedText.toLowerCase() || 
                           fullName.toLowerCase().includes(decodedText.toLowerCase());
                });
                
                if (attendee) {
                    processCheckIn(attendee);
                    
                    // Display scanned attendee data in the sidebar (for plain text QR codes)
                    var plainTextQRData = {
                        type: 'plain-text',
                        content: decodedText,
                        matched_field: attendee.email.toLowerCase() === decodedText.toLowerCase() ? 'email' : 'name'
                    };
                    displayScannedAttendeeData(attendee, plainTextQRData);
                    
                    // Generate and optionally print badge for this attendee
                    setTimeout(function() {
                        displayBadges([attendee]);
                        
                        var autoPrint = document.getElementById('auto-print').checked;
                        if (autoPrint) {
                            setTimeout(function() {
                                printBadges();
                                showAlert('Badge generated and printed for ' + (attendee.full_name || (attendee.firstName + ' ' + attendee.lastName)) + '!', 'success');
                            }, 1000);
                        } else {
                            showAlert('Badge generated for ' + (attendee.full_name || (attendee.firstName + ' ' + attendee.lastName)) + '. Click Print to print the badge.', 'success');
                        }
                    }, 500);
                } else {
                    showAlert('Invalid QR code or attendee not found: ' + decodedText, 'error');
                    scanStats.failedScans++;
                    updateScanStats();
                }
            }
        }

        // QR Scan Failure Callback
        function onScanFailure(error) {
            // Don't log every scan failure as it's normal when no QR code is visible
            // console.warn('QR scan failed:', error);
        }



        // Process check-in
        function processCheckIn(attendee) {
            scanStats.totalScans++;
            
            if (attendee.checked_in_at) {
                scanStats.duplicateScans++;
                showAlert(attendee.full_name + ' is already checked in.', 'warning');
                addToRecentActivity(attendee, 'duplicate');
                updateScanStats();
                return;
            }
            
            // Call backend API to update check-in status
            updateAttendeeCheckIn(attendee)
                .then(function(updatedAttendee) {
                    attendee.checked_in_at = new Date().toISOString();
                    scanStats.successfulScans++;
                    addToRecentActivity(attendee, 'success');
                    showAlert(attendee.full_name + ' checked in successfully!', 'success');
                    
                    // Update display if in print tab
                    if (!document.getElementById('print-content').classList.contains('hidden')) {
                        displayAttendees();
                    }
                    
                    // Update scanner attendee list if in scanner tab
                    if (!document.getElementById('scanner-content').classList.contains('hidden')) {
                        setTimeout(function() {
                            filterAttendeeList();
                        }, 500);
                    }
                    
                    updateScanStats();
                })
                .catch(function(error) {
                    console.error('Error updating check-in status:', error);
                    scanStats.failedScans++;
                    showAlert('Failed to check in ' + attendee.full_name + '. Please try again.', 'error');
                    addToRecentActivity(attendee, 'error');
                    updateScanStats();
                });
        }

        // Update attendee check-in status via API
        function updateAttendeeCheckIn(attendee) {
            return new Promise(function(resolve, reject) {
                var updateData = {
                    firstName: attendee.full_name.split(' ')[0],
                    lastName: attendee.full_name.split(' ').slice(1).join(' ') || '',
                    email: attendee.email,
                    phone: attendee.phone,
                    company: attendee.company,
                    eventId: attendee.event_id,
                    checked_in_at: new Date().toISOString()
                };
                
                fetch(API_BASE_URL + '/attendees/' + attendee.id, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    mode: 'cors',
                    body: JSON.stringify(updateData)
                })
                .then(function(response) {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error('Failed to update attendee');
                    }
                })
                .then(function(result) {
                    resolve(result);
                })
                .catch(function(error) {
                    console.warn('API update failed, continuing with local update:', error);
                    // Continue with local update even if API fails
                    resolve(attendee);
                });
            });
        }

        // Add to recent activity
        function addToRecentActivity(attendee, status) {
            var container = document.getElementById('recent-activity');
            
            // Clear "no activity" message if it exists
            if (container.children.length === 1 && container.textContent.includes('No recent activity')) {
                container.innerHTML = '';
            }
            
            var statusConfig = {
                'success': {
                    class: 'bg-green-50 border-green-200 text-green-800',
                    icon: 'fa-check text-green-600',
                    text: 'Checked In'
                },
                'duplicate': {
                    class: 'bg-yellow-50 border-yellow-200 text-yellow-800',
                    icon: 'fa-exclamation-triangle text-yellow-600',
                    text: 'Already Checked In'
                },
                'error': {
                    class: 'bg-red-50 border-red-200 text-red-800',
                    icon: 'fa-times text-red-600',
                    text: 'Check-in Failed'
                }
            };
            
            var config = statusConfig[status] || statusConfig['error'];
            
            var activityItem = document.createElement('div');
            activityItem.className = 'flex items-center justify-between p-3 rounded-lg border ' + config.class;
            activityItem.innerHTML = '<div class="flex items-center flex-1 min-w-0">' +
                '<div class="flex-shrink-0 mr-3">' +
                    '<i class="fas ' + config.icon + '"></i>' +
                '</div>' +
                '<div class="flex-1 min-w-0">' +
                    '<div class="font-medium text-sm truncate">' + attendee.full_name + '</div>' +
                    '<div class="text-xs opacity-75 truncate">' + attendee.email + '</div>' +
                    '<div class="text-xs opacity-60">' + config.text + '</div>' +
                '</div>' +
            '</div>' +
            '<div class="text-xs opacity-75 flex-shrink-0 ml-2">' +
                new Date().toLocaleTimeString() +
            '</div>';
            
            // Add to top of list
            container.insertBefore(activityItem, container.firstChild);
            
            // Keep only last 10 items
            while (container.children.length > 10) {
                container.removeChild(container.lastChild);
            }
        }

        // Update scan statistics
        function updateScanStats() {
            document.getElementById('totalScans').textContent = scanStats.totalScans;
            document.getElementById('successfulScans').textContent = scanStats.successfulScans;
            document.getElementById('duplicateScans').textContent = scanStats.duplicateScans;
            document.getElementById('failedScans').textContent = scanStats.failedScans;
        }

        // Global variable to store the currently scanned attendee
        var currentScannedAttendee = null;

        // Display scanned attendee data in the sidebar
        function displayScannedAttendeeData(attendee, qrData) {
            currentScannedAttendee = attendee;
            
            var infoSection = document.getElementById('scanned-attendee-info');
            var dataDisplay = document.getElementById('attendee-data-display');
            
            // Build the attendee information display
            var fullName = attendee.full_name || (attendee.firstName && attendee.lastName ? attendee.firstName + ' ' + attendee.lastName : 'N/A');
            var email = attendee.email || 'N/A';
            var company = attendee.company || 'N/A';
            var jobTitle = attendee.jobTitle || 'N/A';
            var phone = attendee.phone || 'N/A';
            var checkInStatus = attendee.checked_in_at ? 'Checked In' : 'Not Checked In';
            var checkInTime = attendee.checked_in_at ? new Date(attendee.checked_in_at).toLocaleString() : 'N/A';
            
            dataDisplay.innerHTML = `
                <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-user text-blue-600 mr-2"></i>
                        <span class="font-semibold text-blue-800">${fullName}</span>
                    </div>
                    <div class="space-y-2 text-sm">
                        <div class="flex items-center">
                            <i class="fas fa-envelope text-gray-500 w-4 mr-2"></i>
                            <span class="text-gray-700">${email}</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-building text-gray-500 w-4 mr-2"></i>
                            <span class="text-gray-700">${company}</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-briefcase text-gray-500 w-4 mr-2"></i>
                            <span class="text-gray-700">${jobTitle}</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-phone text-gray-500 w-4 mr-2"></i>
                            <span class="text-gray-700">${phone}</span>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                    <h4 class="font-semibold text-gray-800 mb-2">
                        <i class="fas fa-qrcode text-gray-600 mr-1"></i>QR Code Data
                    </h4>
                    <pre class="text-xs text-gray-600 whitespace-pre-wrap">${JSON.stringify(qrData, null, 2)}</pre>
                </div>
                
                <div class="bg-${attendee.checked_in_at ? 'green' : 'yellow'}-50 p-3 rounded-lg border border-${attendee.checked_in_at ? 'green' : 'yellow'}-200">
                    <div class="flex items-center justify-between">
                        <span class="font-semibold text-${attendee.checked_in_at ? 'green' : 'yellow'}-800">
                            <i class="fas fa-${attendee.checked_in_at ? 'check-circle' : 'clock'} mr-1"></i>
                            ${checkInStatus}
                        </span>
                        ${attendee.checked_in_at ? `<span class="text-xs text-green-600">${checkInTime}</span>` : ''}
                    </div>
                </div>
            `;
            
            // Show the attendee info section
            infoSection.classList.remove('hidden');
            
            // Scroll to the info section for better visibility
            infoSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Print badge for the currently scanned attendee
        function printScannedAttendeeBadge() {
            if (currentScannedAttendee) {
                // Generate the badge for printing
                displayBadges([currentScannedAttendee]);
                
                // Auto-print the badge after a short delay
                setTimeout(function() {
                    printBadges();
                    showAlert('Badge printed for ' + (currentScannedAttendee.full_name || (currentScannedAttendee.firstName + ' ' + currentScannedAttendee.lastName)) + '!', 'success');
                }, 1000);
            } else {
                showAlert('No attendee data available to print.', 'warning');
            }
        }

        // Hide the scanned attendee info section
        function hideScannedAttendeeData() {
            var infoSection = document.getElementById('scanned-attendee-info');
            infoSection.classList.add('hidden');
            currentScannedAttendee = null;
        }

        // Update general statistics with real data
        function updateStats() {
            // Update basic counts
            document.getElementById('totalEvents').textContent = events.length;
            document.getElementById('selectedCount').textContent = selectedAttendees.length;
            document.getElementById('generatedCount').textContent = document.querySelectorAll('.badge-a6').length;
            
            // Fetch real attendee statistics
            fetchAttendeeStatistics();
        }

        // Fetch real attendee statistics from API
        function fetchAttendeeStatistics() {
            fetch(API_BASE_URL + '/attendees', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                },
                mode: 'cors'
            })
            .then(function(response) {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Failed to fetch attendee statistics');
                }
            })
            .then(function(result) {
                if (result.allAttendees && Array.isArray(result.allAttendees)) {
                    var totalAttendees = result.allAttendees.length;
                    document.getElementById('totalAttendees').textContent = totalAttendees;
                    
                    // If we have a current event, also update event-specific stats
                    if (currentEvent) {
                        var eventAttendees = result.allAttendees.filter(function(attendee) {
                            return attendee.eventId == currentEvent.id || attendee.event_id == currentEvent.id;
                        });
                        
                        // Update the event attendee count in the events array
                        var eventIndex = events.findIndex(function(e) { return e.id == currentEvent.id; });
                        if (eventIndex > -1) {
                            events[eventIndex].attendee_count = eventAttendees.length;
                        }
                    }
                } else {
                    throw new Error('Invalid response format');
                }
            })
            .catch(function(error) {
                console.error('Error fetching attendee statistics:', error);
                // Fallback to calculated total from events
                var totalAttendees = events.reduce(function(sum, event) { 
                    return sum + (event.attendee_count || 0); 
                }, 0);
                document.getElementById('totalAttendees').textContent = totalAttendees;
            });
        }

        // Utility functions
        function showLoading() {
            var overlay = document.getElementById('loadingOverlay');
            overlay.classList.remove('hidden');
            overlay.style.display = 'flex';
        }

        function hideLoading() {
            var overlay = document.getElementById('loadingOverlay');
            overlay.classList.add('hidden');
            overlay.style.display = 'none';
        }

        function showAlert(message, type) {
            var alertContainer = document.getElementById('alertContainer');
            var alertMessage = document.getElementById('alertMessage');
            var alertText = document.getElementById('alertText');
            
            var colorClasses = {
                'success': 'bg-green-100 text-green-800 border-green-200',
                'error': 'bg-red-100 text-red-800 border-red-200',
                'warning': 'bg-yellow-100 text-yellow-800 border-yellow-200',
                'info': 'bg-blue-100 text-blue-800 border-blue-200'
            };
            
            alertMessage.className = 'px-6 py-4 rounded-lg shadow-lg border ' + (colorClasses[type] || colorClasses.info);
            alertText.textContent = message;
            alertContainer.classList.remove('hidden');
            
            setTimeout(function() {
                alertContainer.classList.add('hidden');
            }, 5000);
        }
    </script>
</body>
</html>